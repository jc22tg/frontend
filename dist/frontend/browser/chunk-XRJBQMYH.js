import{a as ot,b as st}from"./chunk-YFTEGT7S.js";import{m as ut}from"./chunk-7JRIPI7N.js";import"./chunk-MHWJR3EV.js";import{a as et,b as nt,i as rt,n as it}from"./chunk-XJSBNB6N.js";import{v as at,w as ct}from"./chunk-VH7SA6GK.js";import"./chunk-4PHUDKEH.js";import{$ as U,$a as x,$b as Q,$c as Z,A as _,C as G,D as S,Gb as j,Hb as K,I as M,Ob as X,Y as V,_b as J,a as z,da as H,db as w,g as p,id as tt,ja as m,kb as q,oa as b,s as y,t as Y,xb as W,z as P}from"./chunk-FG6FKNI4.js";import{a as I,b as v,g as d,h as O,i as F}from"./chunk-OXVY4BEJ.js";var a=function(e){return e.SYNCED="synced",e.SYNCING="syncing",e.PENDING="pending",e.OFFLINE="offline",e.ERROR="error",e.FAILED="failed",e}(a||{});var l=function(e){return e.CREATE="CREATE",e.UPDATE="UPDATE",e.DELETE="DELETE",e}(l||{});var L=(e,r)=>r.some(t=>e instanceof t),dt,lt;function It(){return dt||(dt=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function vt(){return lt||(lt=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}var B=new WeakMap,k=new WeakMap,g=new WeakMap;function Ot(e){let r=new Promise((t,n)=>{let i=()=>{e.removeEventListener("success",s),e.removeEventListener("error",o)},s=()=>{t(f(e.result)),i()},o=()=>{n(e.error),i()};e.addEventListener("success",s),e.addEventListener("error",o)});return g.set(r,e),r}function Pt(e){if(B.has(e))return;let r=new Promise((t,n)=>{let i=()=>{e.removeEventListener("complete",s),e.removeEventListener("error",o),e.removeEventListener("abort",o)},s=()=>{t(),i()},o=()=>{n(e.error||new DOMException("AbortError","AbortError")),i()};e.addEventListener("complete",s),e.addEventListener("error",o),e.addEventListener("abort",o)});B.set(e,r)}var $={get(e,r,t){if(e instanceof IDBTransaction){if(r==="done")return B.get(e);if(r==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return f(e[r])},set(e,r,t){return e[r]=t,!0},has(e,r){return e instanceof IDBTransaction&&(r==="done"||r==="store")?!0:r in e}};function mt(e){$=e($)}function Mt(e){return vt().includes(e)?function(...r){return e.apply(N(this),r),f(this.request)}:function(...r){return f(e.apply(N(this),r))}}function xt(e){return typeof e=="function"?Mt(e):(e instanceof IDBTransaction&&Pt(e),L(e,It())?new Proxy(e,$):e)}function f(e){if(e instanceof IDBRequest)return Ot(e);if(k.has(e))return k.get(e);let r=xt(e);return r!==e&&(k.set(e,r),g.set(r,e)),r}var N=e=>g.get(e);function yt(e,r,{blocked:t,upgrade:n,blocking:i,terminated:s}={}){let o=indexedDB.open(e,r),u=f(o);return n&&o.addEventListener("upgradeneeded",c=>{n(f(o.result),c.oldVersion,c.newVersion,f(o.transaction),c)}),t&&o.addEventListener("blocked",c=>t(c.oldVersion,c.newVersion,c)),u.then(c=>{s&&c.addEventListener("close",()=>s()),i&&c.addEventListener("versionchange",h=>i(h.oldVersion,h.newVersion,h))}).catch(()=>{}),u}var jt=["get","getKey","getAll","getAllKeys","count"],kt=["put","add","delete","clear"],T=new Map;function ht(e,r){if(!(e instanceof IDBDatabase&&!(r in e)&&typeof r=="string"))return;if(T.get(r))return T.get(r);let t=r.replace(/FromIndex$/,""),n=r!==t,i=kt.includes(t);if(!(t in(n?IDBIndex:IDBObjectStore).prototype)||!(i||jt.includes(t)))return;let s=function(o,...u){return d(this,null,function*(){let c=this.transaction(o,i?"readwrite":"readonly"),h=c.store;return n&&(h=h.index(u.shift())),(yield Promise.all([h[t](...u),i&&c.done]))[0]})};return T.set(r,s),s}mt(e=>v(I({},e),{get:(r,t,n)=>ht(r,t)||e.get(r,t,n),has:(r,t)=>!!ht(r,t)||e.has(r,t)}));var Tt=["continue","continuePrimaryKey","advance"],pt={},R=new WeakMap,bt=new WeakMap,Lt={get(e,r){if(!Tt.includes(r))return e[r];let t=pt[r];return t||(t=pt[r]=function(...n){R.set(this,bt.get(this)[r](...n))}),t}};function Bt(...e){return F(this,null,function*(){let r=this;if(r instanceof IDBCursor||(r=yield new O(r.openCursor(...e))),!r)return;r=r;let t=new Proxy(r,Lt);for(bt.set(t,r),g.set(t,N(r));r;)yield t,r=yield new O(R.get(t)||r.continue()),R.delete(t)})}function ft(e,r){return r===Symbol.asyncIterator&&L(e,[IDBIndex,IDBObjectStore,IDBCursor])||r==="iterate"&&L(e,[IDBIndex,IDBObjectStore])}mt(e=>v(I({},e),{get(r,t,n){return ft(r,t)?Bt:e.get(r,t,n)},has(r,t){return ft(r,t)||e.has(r,t)}}));var St=1,$t="network-map-offline",E=(()=>{class e{constructor(){this.db=null,this.operationsCount=new p(0),this.operationsCount$=this.operationsCount.asObservable(),this.defaultStores=[{name:"operations",keyPath:"id",indexes:[{name:"timestamp",keyPath:"timestamp"},{name:"storeName",keyPath:"storeName"},{name:"priority",keyPath:"priority"}]},{name:"networkElements",keyPath:"id",indexes:[{name:"type",keyPath:"type"},{name:"status",keyPath:"status"}]},{name:"connections",keyPath:"id",indexes:[{name:"sourceId",keyPath:"sourceId"},{name:"targetId",keyPath:"targetId"}]}],this.additionalStoreConfigs=[],this.initDatabase()}registerStores(t){this.additionalStoreConfigs=[...this.additionalStoreConfigs,...t],this.db&&(this.db.close(),this.initDatabase(St+1))}initDatabase(){return d(this,arguments,function*(t=St){try{let n=[...this.defaultStores,...this.additionalStoreConfigs];this.db=yield yt($t,t,{upgrade(i,s,o,u){for(let c of n)if(!i.objectStoreNames.contains(c.name)){let h=i.createObjectStore(c.name,{keyPath:c.keyPath});if(c.indexes)for(let C of c.indexes)h.createIndex(C.name,C.keyPath,{unique:C.unique||!1})}}}),this.updateOperationsCount(),console.log("Base de datos offline inicializada correctamente")}catch(n){console.error("Error al inicializar la base de datos offline:",n)}})}ensureDb(){return d(this,null,function*(){if(this.db||(yield this.initDatabase()),!this.db)throw new Error("No se pudo inicializar la base de datos offline");return this.db})}get(t,n){return d(this,null,function*(){try{return yield(yield this.ensureDb()).get(t,n)}catch(i){console.error(`Error al obtener datos de ${t}:`,i);return}})}getAll(t){return d(this,null,function*(){try{return yield(yield this.ensureDb()).getAll(t)}catch(n){return console.error(`Error al obtener todos los datos de ${t}:`,n),[]}})}set(t,n,i,s=!0,o=1){return d(this,null,function*(){try{yield(yield this.ensureDb()).put(t,i),s&&(yield this.addOperation({id:`${t}_${n}_${Date.now()}`,timestamp:Date.now(),storeName:t,type:l.UPDATE,key:n,data:i,priority:o,attempts:0}))}catch(u){throw console.error(`Error al almacenar datos en ${t}:`,u),u}})}delete(t,n,i=!0,s=1){return d(this,null,function*(){try{yield(yield this.ensureDb()).delete(t,n),i&&(yield this.addOperation({id:`${t}_${n}_${Date.now()}`,timestamp:Date.now(),storeName:t,type:l.DELETE,key:n,priority:s,attempts:0}))}catch(o){throw console.error(`Error al eliminar datos de ${t}:`,o),o}})}clearStore(t){return d(this,null,function*(){try{yield(yield this.ensureDb()).clear(t)}catch(n){throw console.error(`Error al limpiar el almac\xE9n ${t}:`,n),n}})}addOperation(t){return d(this,null,function*(){try{yield(yield this.ensureDb()).add("operations",t),yield this.updateOperationsCount()}catch(n){throw console.error("Error al a\xF1adir operaci\xF3n a la cola:",n),n}})}getPendingOperations(t=50){return d(this,null,function*(){try{return(yield(yield this.ensureDb()).transaction("operations","readonly").store.index("priority").getAll()).sort((u,c)=>u.priority!==c.priority?c.priority-u.priority:u.timestamp-c.timestamp).slice(0,t)}catch(n){return console.error("Error al obtener operaciones pendientes:",n),[]}})}removeOperation(t){return d(this,null,function*(){try{yield(yield this.ensureDb()).delete("operations",t),yield this.updateOperationsCount()}catch(n){throw console.error("Error al eliminar operaci\xF3n completada:",n),n}})}updateOperationsCount(){return d(this,null,function*(){try{let n=yield(yield this.ensureDb()).count("operations");this.operationsCount.next(n)}catch(t){console.error("Error al actualizar contador de operaciones:",t),this.operationsCount.next(0)}})}updateOperationAttempt(t){return d(this,null,function*(){try{let n=yield this.ensureDb(),i=yield n.get("operations",t);i&&(i.attempts+=1,i.lastAttempt=Date.now(),yield n.put("operations",i))}catch(n){throw console.error("Error al actualizar intento de operaci\xF3n:",n),n}})}getByIndex(t,n,i){return d(this,null,function*(){try{return yield(yield this.ensureDb()).transaction(t,"readonly").store.index(n).getAll(i)}catch(s){return console.error(`Error al buscar por \xEDndice ${n} en ${t}:`,s),[]}})}static{this.\u0275fac=function(n){return new(n||e)}}static{this.\u0275prov=m({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})();var D=(()=>{class e{constructor(){this.onlineSubject=new p(navigator.onLine),this.initConnectionListeners(),this.online$=G(this.onlineSubject.asObservable(),P(window,"online").pipe(y(()=>!0)),P(window,"offline").pipe(y(()=>!1))).pipe(U(1)),this.setupPeriodicConnectivityCheck()}initConnectionListeners(){window.addEventListener("online",()=>{this.onlineSubject.next(!0)}),window.addEventListener("offline",()=>{this.onlineSubject.next(!1)})}setupPeriodicConnectivityCheck(){setInterval(()=>{navigator.onLine&&this.checkRealConnectivity()},3e4)}checkRealConnectivity(){return d(this,null,function*(){try{let n=(yield fetch("/api/health-check",{method:"HEAD",headers:{"Cache-Control":"no-cache",Pragma:"no-cache"},signal:AbortSignal.timeout(5e3)})).ok;!n&&this.onlineSubject.value?this.onlineSubject.next(!1):n&&!this.onlineSubject.value&&this.onlineSubject.next(!0)}catch{this.onlineSubject.value&&this.onlineSubject.next(!1)}})}checkConnectivity(){return new Promise(t=>{if(!navigator.onLine){t(!1);return}this.checkRealConnectivity().then(()=>{t(this.onlineSubject.value)})})}static{this.\u0275fac=function(n){return new(n||e)}}static{this.\u0275prov=m({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})();var Et=5,Nt=5e3,Dt=(()=>{class e{constructor(t,n,i,s){this.offlineStorage=t,this.connectionService=n,this.http=i,this.store=s,this.syncStatusSubject=new p(a.SYNCED),this.syncStatus$=this.syncStatusSubject.asObservable(),this.isSyncing=!1,this.forceSyncSubject=new p(!1),this.initSyncListeners()}initSyncListeners(){this.connectionService.online$.pipe(S(t=>t),M(2e3)).subscribe(()=>{this.syncPendingOperations()}),this.offlineStorage.operationsCount$.pipe(M(1e3)).subscribe(t=>{t>0?this.connectionService.online$.pipe(S(n=>n),H(_(100))).subscribe(()=>{this.syncPendingOperations()}):t===0&&this.syncStatusSubject.value===a.PENDING&&this.syncStatusSubject.next(a.SYNCED)}),this.forceSyncSubject.pipe(S(t=>t)).subscribe(()=>{this.syncPendingOperations(),this.forceSyncSubject.next(!1)})}syncPendingOperations(){return d(this,null,function*(){if(this.isSyncing)return;if(!(yield this.connectionService.checkConnectivity())){this.syncStatusSubject.next(a.OFFLINE);return}this.isSyncing=!0,this.syncStatusSubject.next(a.SYNCING);try{let n=yield this.offlineStorage.getPendingOperations();if(n.length===0){this.syncStatusSubject.next(a.SYNCED),this.isSyncing=!1;return}for(let s of n)try{yield this.processOperation(s),yield this.offlineStorage.removeOperation(s.id)}catch(o){yield this.offlineStorage.updateOperationAttempt(s.id),s.attempts>=Et?(console.warn(`Operaci\xF3n ${s.id} abandonada despu\xE9s de ${Et} intentos.`),yield this.offlineStorage.removeOperation(s.id)):(console.error("Error during sync operation:",o),this.syncStatusSubject.next(a.FAILED))}let i=yield this.offlineStorage.getPendingOperations();this.syncStatusSubject.next(i.length>0?a.PENDING:a.SYNCED)}catch(n){console.error("Error durante la sincronizaci\xF3n:",n),this.syncStatusSubject.next(a.FAILED)}finally{this.isSyncing=!1}})}forceSync(){this.forceSyncSubject.next(!0)}processOperation(t){return d(this,null,function*(){let n=t.attempts>0?Math.min(Nt*Math.pow(2,t.attempts-1),6e4):0;n>0&&(yield new Promise(o=>setTimeout(o,n)));let i=this.getUrlForStore(t.storeName,t.key),s;switch(t.type){case l.CREATE:s="POST";break;case l.UPDATE:s="PUT";break;case l.DELETE:s="DELETE";break;default:throw new Error(`Tipo de operaci\xF3n no soportado: ${t.type}`)}try{let o=yield this.executeHttpRequest(s,i,t.data);return t.type!==l.DELETE&&(yield this.offlineStorage.set(t.storeName,t.key,o,!1)),o}catch(o){if(console.error(`Error al procesar operaci\xF3n ${t.id}:`,o),t.type===l.DELETE&&typeof o=="object"&&o!==null&&"status"in o&&o.status===404)return;throw o}})}executeHttpRequest(t,n,i){return new Promise((s,o)=>{let u;switch(t){case"GET":u=this.http.get(n);break;case"POST":u=this.http.post(n,i);break;case"PUT":u=this.http.put(n,i);break;case"PATCH":u=this.http.patch(n,i);break;case"DELETE":u=this.http.delete(n);break;default:o(new Error(`M\xE9todo HTTP no soportado: ${t}`));return}u.pipe(V(2)).subscribe({next:c=>s(c),error:c=>o(c)})})}getUrlForStore(t,n){let i="/api";switch(t){case"networkElements":return`${i}/network-elements/${n}`;case"connections":return`${i}/connections/${n}`;default:return`${i}/${t.toLowerCase()}/${n}`}}pullServerChanges(t){return d(this,null,function*(){if(yield this.connectionService.checkConnectivity())try{let i=`/api/${t.toLowerCase()}`,s=yield this.executeHttpRequest("GET",i);for(let o of s){let u=o.id.toString();yield this.offlineStorage.set(t,u,o,!1)}}catch(i){throw console.error(`Error al obtener cambios del servidor para ${t}:`,i),i}})}static{this.\u0275fac=function(n){return new(n||e)(b(E),b(D),b(tt),b(ut))}}static{this.\u0275prov=m({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})();var Ct=(()=>{class e{constructor(t,n,i){this.syncService=t,this.offlineStorage=n,this.connectionService=i,this.statusMessage="",this.tooltipMessage="",this.operationsCount=0,this.isOnline=navigator.onLine,this.currentStatus=a.SYNCED,this.subscriptions=new z}ngOnInit(){let t=Y([this.connectionService.online$,this.syncService.syncStatus$,this.offlineStorage.operationsCount$]).pipe(y(([n,i,s])=>(this.isOnline=n,this.currentStatus=i,this.operationsCount=s,this.updateStatusMessages(),{isOnline:n,syncStatus:i,operationsCount:s}))).subscribe();this.subscriptions.add(t)}ngOnDestroy(){this.subscriptions.unsubscribe()}updateStatusMessages(){if(!this.isOnline){this.statusMessage="Sin conexi\xF3n",this.tooltipMessage="No hay conexi\xF3n a internet. Los cambios se sincronizar\xE1n cuando est\xE9s online.";return}switch(this.currentStatus){case a.SYNCED:this.statusMessage="Sincronizado",this.tooltipMessage="Todos los cambios est\xE1n sincronizados con el servidor.";break;case a.SYNCING:this.statusMessage="Sincronizando...",this.tooltipMessage="Sincronizando cambios con el servidor...";break;case a.PENDING:let t=this.operationsCount;this.statusMessage=`Pendiente (${t})`,this.tooltipMessage=`${t} ${t===1?"cambio pendiente":"cambios pendientes"} de sincronizaci\xF3n. Haz clic para sincronizar ahora.`;break;case a.ERROR:this.statusMessage="Error de sincronizaci\xF3n",this.tooltipMessage="Error al sincronizar cambios. Haz clic para reintentar.";break;case a.OFFLINE:this.statusMessage="Modo offline",this.tooltipMessage="Trabajando en modo offline. Los cambios se sincronizar\xE1n cuando vuelvas online.";break;default:this.statusMessage="Desconocido",this.tooltipMessage="Estado de sincronizaci\xF3n desconocido."}}getStatusIcon(){if(!this.isOnline)return"cloud_off";switch(this.currentStatus){case a.SYNCED:return"cloud_done";case a.SYNCING:return"sync";case a.PENDING:return"cloud_queue";case a.ERROR:return"cloud_off";case a.OFFLINE:return"cloud_off";default:return"help"}}getStatusColor(){if(!this.isOnline)return"warn";switch(this.currentStatus){case a.SYNCED:return"primary";case a.SYNCING:return"accent";case a.PENDING:return"accent";case a.ERROR:return"warn";case a.OFFLINE:return"warn";default:return""}}triggerSync(){this.isOnline&&(this.currentStatus===a.PENDING||this.currentStatus===a.ERROR)&&this.syncService.forceSync()}static{this.\u0275fac=function(n){return new(n||e)(w(Dt),w(E),w(D))}}static{this.\u0275cmp=q({type:e,selectors:[["app-sync-status"]],decls:4,vars:4,consts:[[1,"sync-status-container"],["mat-icon-button","","matBadgeColor","warn","matBadgeSize","small",3,"click","matTooltip","color","matBadge"]],template:function(n,i){n&1&&(j(0,"div",0)(1,"button",1),X("click",function(){return i.triggerSync()}),j(2,"mat-icon"),J(3),K()()()),n&2&&(x(),W("matTooltip",i.tooltipMessage)("color",i.getStatusColor())("matBadge",i.operationsCount>0?i.operationsCount:null),x(2),Q(i.getStatusIcon()))},dependencies:[Z,nt,et,ct,at,it,rt,st,ot],styles:[".sync-status-container[_ngcontent-%COMP%]{display:inline-block}button[matBadge][_ngcontent-%COMP%]{margin-right:8px}"]})}}return e})();var ye=[{path:"",redirectTo:"sync",pathMatch:"full"},{path:"sync",component:Ct}];export{ye as OFFLINE_ROUTES};
