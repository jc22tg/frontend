import{a as re,b as oe}from"./chunk-YFTEGT7S.js";import{m as ce}from"./chunk-7JRIPI7N.js";import"./chunk-MHWJR3EV.js";import{a as ee,b as te,i as ne,n as ie}from"./chunk-XJSBNB6N.js";import{v as se,w as ae}from"./chunk-VH7SA6GK.js";import"./chunk-4PHUDKEH.js";import{$ as V,$a as M,$b as J,$c as Q,A as Y,C as _,D as S,Gb as x,Hb as W,I,Ob as K,Y as G,_b as X,a as F,da as H,db as g,g as p,id as Z,ja as f,kb as U,oa as y,s as b,t as z,xb as q,z as P}from"./chunk-FG6FKNI4.js";import{a as D,b as C,g as a,h as O,i as A}from"./chunk-OXVY4BEJ.js";var j=(n,e)=>e.some(t=>n instanceof t),ue,le;function we(){return ue||(ue=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Ee(){return le||(le=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}var L=new WeakMap,T=new WeakMap,v=new WeakMap;function De(n){let e=new Promise((t,i)=>{let r=()=>{n.removeEventListener("success",o),n.removeEventListener("error",s)},o=()=>{t(d(n.result)),r()},s=()=>{i(n.error),r()};n.addEventListener("success",o),n.addEventListener("error",s)});return v.set(e,n),e}function Ce(n){if(L.has(n))return;let e=new Promise((t,i)=>{let r=()=>{n.removeEventListener("complete",o),n.removeEventListener("error",s),n.removeEventListener("abort",s)},o=()=>{t(),r()},s=()=>{i(n.error||new DOMException("AbortError","AbortError")),r()};n.addEventListener("complete",o),n.addEventListener("error",s),n.addEventListener("abort",s)});L.set(n,e)}var B={get(n,e,t){if(n instanceof IDBTransaction){if(e==="done")return L.get(n);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return d(n[e])},set(n,e,t){return n[e]=t,!0},has(n,e){return n instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in n}};function me(n){B=n(B)}function Oe(n){return Ee().includes(n)?function(...e){return n.apply($(this),e),d(this.request)}:function(...e){return d(n.apply($(this),e))}}function Pe(n){return typeof n=="function"?Oe(n):(n instanceof IDBTransaction&&Ce(n),j(n,we())?new Proxy(n,B):n)}function d(n){if(n instanceof IDBRequest)return De(n);if(T.has(n))return T.get(n);let e=Pe(n);return e!==n&&(T.set(n,e),v.set(e,n)),e}var $=n=>v.get(n);function he(n,e,{blocked:t,upgrade:i,blocking:r,terminated:o}={}){let s=indexedDB.open(n,e),c=d(s);return i&&s.addEventListener("upgradeneeded",u=>{i(d(s.result),u.oldVersion,u.newVersion,d(s.transaction),u)}),t&&s.addEventListener("blocked",u=>t(u.oldVersion,u.newVersion,u)),c.then(u=>{o&&u.addEventListener("close",()=>o()),r&&u.addEventListener("versionchange",l=>r(l.oldVersion,l.newVersion,l))}).catch(()=>{}),c}var Ie=["get","getKey","getAll","getAllKeys","count"],Me=["put","add","delete","clear"],k=new Map;function pe(n,e){if(!(n instanceof IDBDatabase&&!(e in n)&&typeof e=="string"))return;if(k.get(e))return k.get(e);let t=e.replace(/FromIndex$/,""),i=e!==t,r=Me.includes(t);if(!(t in(i?IDBIndex:IDBObjectStore).prototype)||!(r||Ie.includes(t)))return;let o=function(s,...c){return a(this,null,function*(){let u=this.transaction(s,r?"readwrite":"readonly"),l=u.store;return i&&(l=l.index(c.shift())),(yield Promise.all([l[t](...c),r&&u.done]))[0]})};return k.set(e,o),o}me(n=>C(D({},n),{get:(e,t,i)=>pe(e,t)||n.get(e,t,i),has:(e,t)=>!!pe(e,t)||n.has(e,t)}));var xe=["continue","continuePrimaryKey","advance"],de={},N=new WeakMap,be=new WeakMap,Te={get(n,e){if(!xe.includes(e))return n[e];let t=de[e];return t||(t=de[e]=function(...i){N.set(this,be.get(this)[e](...i))}),t}};function ke(...n){return A(this,null,function*(){let e=this;if(e instanceof IDBCursor||(e=yield new O(e.openCursor(...n))),!e)return;e=e;let t=new Proxy(e,Te);for(be.set(t,e),v.set(t,$(e));e;)yield t,e=yield new O(N.get(t)||e.continue()),N.delete(t)})}function fe(n,e){return e===Symbol.asyncIterator&&j(n,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&j(n,[IDBIndex,IDBObjectStore])}me(n=>C(D({},n),{get(e,t,i){return fe(e,t)?ke:n.get(e,t,i)},has(e,t){return fe(e,t)||n.has(e,t)}}));var ye=1,Le="network-map-offline",m=class n{db=null;operationsCount=new p(0);operationsCount$=this.operationsCount.asObservable();defaultStores=[{name:"operations",keyPath:"id",indexes:[{name:"timestamp",keyPath:"timestamp"},{name:"storeName",keyPath:"storeName"},{name:"priority",keyPath:"priority"}]},{name:"networkElements",keyPath:"id",indexes:[{name:"type",keyPath:"type"},{name:"status",keyPath:"status"}]},{name:"connections",keyPath:"id",indexes:[{name:"sourceId",keyPath:"sourceId"},{name:"targetId",keyPath:"targetId"}]}];additionalStoreConfigs=[];constructor(){this.initDatabase()}registerStores(e){this.additionalStoreConfigs=[...this.additionalStoreConfigs,...e],this.db&&(this.db.close(),this.initDatabase(ye+1))}initDatabase(){return a(this,arguments,function*(e=ye){try{let t=[...this.defaultStores,...this.additionalStoreConfigs];this.db=yield he(Le,e,{upgrade(i,r,o,s){for(let c of t)if(!i.objectStoreNames.contains(c.name)){let u=i.createObjectStore(c.name,{keyPath:c.keyPath});if(c.indexes)for(let l of c.indexes)u.createIndex(l.name,l.keyPath,{unique:l.unique||!1})}}}),this.updateOperationsCount(),console.log("Base de datos offline inicializada correctamente")}catch(t){console.error("Error al inicializar la base de datos offline:",t)}})}ensureDb(){return a(this,null,function*(){if(this.db||(yield this.initDatabase()),!this.db)throw new Error("No se pudo inicializar la base de datos offline");return this.db})}get(e,t){return a(this,null,function*(){try{return yield(yield this.ensureDb()).get(e,t)}catch(i){console.error(`Error al obtener datos de ${e}:`,i);return}})}getAll(e){return a(this,null,function*(){try{return yield(yield this.ensureDb()).getAll(e)}catch(t){return console.error(`Error al obtener todos los datos de ${e}:`,t),[]}})}set(e,t,i,r=!0,o=1){return a(this,null,function*(){try{yield(yield this.ensureDb()).put(e,i),r&&(yield this.addOperation({id:`${e}_${t}_${Date.now()}`,timestamp:Date.now(),storeName:e,type:"UPDATE",key:t,data:i,priority:o,attempts:0}))}catch(s){throw console.error(`Error al almacenar datos en ${e}:`,s),s}})}delete(e,t,i=!0,r=1){return a(this,null,function*(){try{yield(yield this.ensureDb()).delete(e,t),i&&(yield this.addOperation({id:`${e}_${t}_${Date.now()}`,timestamp:Date.now(),storeName:e,type:"DELETE",key:t,priority:r,attempts:0}))}catch(o){throw console.error(`Error al eliminar datos de ${e}:`,o),o}})}clearStore(e){return a(this,null,function*(){try{yield(yield this.ensureDb()).clear(e)}catch(t){throw console.error(`Error al limpiar el almac\xE9n ${e}:`,t),t}})}addOperation(e){return a(this,null,function*(){try{yield(yield this.ensureDb()).add("operations",e),yield this.updateOperationsCount()}catch(t){throw console.error("Error al a\xF1adir operaci\xF3n a la cola:",t),t}})}getPendingOperations(e=50){return a(this,null,function*(){try{return(yield(yield this.ensureDb()).transaction("operations","readonly").store.index("priority").getAll()).sort((s,c)=>s.priority!==c.priority?c.priority-s.priority:s.timestamp-c.timestamp).slice(0,e)}catch(t){return console.error("Error al obtener operaciones pendientes:",t),[]}})}removeOperation(e){return a(this,null,function*(){try{yield(yield this.ensureDb()).delete("operations",e),yield this.updateOperationsCount()}catch(t){throw console.error("Error al eliminar operaci\xF3n completada:",t),t}})}updateOperationsCount(){return a(this,null,function*(){try{let t=yield(yield this.ensureDb()).count("operations");this.operationsCount.next(t)}catch(e){console.error("Error al actualizar contador de operaciones:",e),this.operationsCount.next(0)}})}updateOperationAttempt(e){return a(this,null,function*(){try{let t=yield this.ensureDb(),i=yield t.get("operations",e);i&&(i.attempts+=1,i.lastAttempt=Date.now(),yield t.put("operations",i))}catch(t){throw console.error("Error al actualizar intento de operaci\xF3n:",t),t}})}getByIndex(e,t,i){return a(this,null,function*(){try{return yield(yield this.ensureDb()).transaction(e,"readonly").store.index(t).getAll(i)}catch(r){return console.error(`Error al buscar por \xEDndice ${t} en ${e}:`,r),[]}})}static \u0275fac=function(t){return new(t||n)};static \u0275prov=f({token:n,factory:n.\u0275fac,providedIn:"root"})};var h=class n{onlineSubject=new p(navigator.onLine);online$;constructor(){this.initConnectionListeners(),this.online$=_(this.onlineSubject.asObservable(),P(window,"online").pipe(b(()=>!0)),P(window,"offline").pipe(b(()=>!1))).pipe(V(1)),this.setupPeriodicConnectivityCheck()}initConnectionListeners(){window.addEventListener("online",()=>{this.onlineSubject.next(!0)}),window.addEventListener("offline",()=>{this.onlineSubject.next(!1)})}setupPeriodicConnectivityCheck(){setInterval(()=>{navigator.onLine&&this.checkRealConnectivity()},3e4)}checkRealConnectivity(){return a(this,null,function*(){try{let t=(yield fetch("/api/health-check",{method:"HEAD",headers:{"Cache-Control":"no-cache",Pragma:"no-cache"},signal:AbortSignal.timeout(5e3)})).ok;!t&&this.onlineSubject.value?this.onlineSubject.next(!1):t&&!this.onlineSubject.value&&this.onlineSubject.next(!0)}catch{this.onlineSubject.value&&this.onlineSubject.next(!1)}})}checkConnectivity(){return new Promise(e=>{if(!navigator.onLine){e(!1);return}this.checkRealConnectivity().then(()=>{e(this.onlineSubject.value)})})}static \u0275fac=function(t){return new(t||n)};static \u0275prov=f({token:n,factory:n.\u0275fac,providedIn:"root"})};var ve=5,$e=5e3,w=class n{constructor(e,t,i,r){this.offlineStorage=e;this.connectionService=t;this.http=i;this.store=r;this.initSyncListeners()}syncStatusSubject=new p("synced");syncStatus$=this.syncStatusSubject.asObservable();isSyncing=!1;forceSyncSubject=new p(!1);initSyncListeners(){this.connectionService.online$.pipe(S(e=>e),I(2e3)).subscribe(()=>{this.syncPendingOperations()}),this.offlineStorage.operationsCount$.pipe(I(1e3)).subscribe(e=>{e>0?this.connectionService.online$.pipe(S(t=>t),H(Y(100))).subscribe(()=>{this.syncPendingOperations()}):e===0&&this.syncStatusSubject.value==="pending"&&this.syncStatusSubject.next("synced")}),this.forceSyncSubject.pipe(S(e=>e)).subscribe(()=>{this.syncPendingOperations(),this.forceSyncSubject.next(!1)})}syncPendingOperations(){return a(this,null,function*(){if(this.isSyncing)return;if(!(yield this.connectionService.checkConnectivity())){this.syncStatusSubject.next("offline");return}this.isSyncing=!0,this.syncStatusSubject.next("syncing");try{let t=yield this.offlineStorage.getPendingOperations();if(t.length===0){this.syncStatusSubject.next("synced"),this.isSyncing=!1;return}for(let r of t)try{yield this.processOperation(r),yield this.offlineStorage.removeOperation(r.id)}catch(o){yield this.offlineStorage.updateOperationAttempt(r.id),r.attempts>=ve?(console.warn(`Operaci\xF3n ${r.id} abandonada despu\xE9s de ${ve} intentos.`),yield this.offlineStorage.removeOperation(r.id)):(console.error("Error during sync operation:",o),this.syncStatusSubject.next("failed"))}let i=yield this.offlineStorage.getPendingOperations();this.syncStatusSubject.next(i.length>0?"pending":"synced")}catch(t){console.error("Error durante la sincronizaci\xF3n:",t),this.syncStatusSubject.next("failed")}finally{this.isSyncing=!1}})}forceSync(){this.forceSyncSubject.next(!0)}processOperation(e){return a(this,null,function*(){let t=e.attempts>0?Math.min($e*Math.pow(2,e.attempts-1),6e4):0;t>0&&(yield new Promise(o=>setTimeout(o,t)));let i=this.getUrlForStore(e.storeName,e.key),r;switch(e.type){case"CREATE":r="POST";break;case"UPDATE":r="PUT";break;case"DELETE":r="DELETE";break;default:throw new Error(`Tipo de operaci\xF3n no soportado: ${e.type}`)}try{let o=yield this.executeHttpRequest(r,i,e.data);return e.type!=="DELETE"&&(yield this.offlineStorage.set(e.storeName,e.key,o,!1)),o}catch(o){if(console.error(`Error al procesar operaci\xF3n ${e.id}:`,o),e.type==="DELETE"&&typeof o=="object"&&o!==null&&"status"in o&&o.status===404)return;throw o}})}executeHttpRequest(e,t,i){return new Promise((r,o)=>{let s;switch(e){case"GET":s=this.http.get(t);break;case"POST":s=this.http.post(t,i);break;case"PUT":s=this.http.put(t,i);break;case"PATCH":s=this.http.patch(t,i);break;case"DELETE":s=this.http.delete(t);break;default:o(new Error(`M\xE9todo HTTP no soportado: ${e}`));return}s.pipe(G(2)).subscribe({next:c=>r(c),error:c=>o(c)})})}getUrlForStore(e,t){let i="/api";switch(e){case"networkElements":return`${i}/network-elements/${t}`;case"connections":return`${i}/connections/${t}`;default:return`${i}/${e.toLowerCase()}/${t}`}}pullServerChanges(e){return a(this,null,function*(){if(yield this.connectionService.checkConnectivity())try{let i=`/api/${e.toLowerCase()}`,r=yield this.executeHttpRequest("GET",i);for(let o of r){let s=o.id.toString();yield this.offlineStorage.set(e,s,o,!1)}}catch(i){throw console.error(`Error al obtener cambios del servidor para ${e}:`,i),i}})}static \u0275fac=function(t){return new(t||n)(y(m),y(h),y(Z),y(ce))};static \u0275prov=f({token:n,factory:n.\u0275fac,providedIn:"root"})};var E=class n{constructor(e,t,i){this.syncService=e;this.offlineStorage=t;this.connectionService=i}statusMessage="";tooltipMessage="";operationsCount=0;isOnline=navigator.onLine;currentStatus="synced";subscriptions=new F;ngOnInit(){let e=z([this.connectionService.online$,this.syncService.syncStatus$,this.offlineStorage.operationsCount$]).pipe(b(([t,i,r])=>(this.isOnline=t,this.currentStatus=i,this.operationsCount=r,this.updateStatusMessages(),{isOnline:t,syncStatus:i,operationsCount:r}))).subscribe();this.subscriptions.add(e)}ngOnDestroy(){this.subscriptions.unsubscribe()}updateStatusMessages(){if(!this.isOnline){this.statusMessage="Sin conexi\xF3n",this.tooltipMessage="No hay conexi\xF3n a internet. Los cambios se sincronizar\xE1n cuando est\xE9s online.";return}switch(this.currentStatus){case"synced":this.statusMessage="Sincronizado",this.tooltipMessage="Todos los cambios est\xE1n sincronizados con el servidor.";break;case"syncing":this.statusMessage="Sincronizando...",this.tooltipMessage="Sincronizando cambios con el servidor...";break;case"pending":let e=this.operationsCount;this.statusMessage=`Pendiente (${e})`,this.tooltipMessage=`${e} ${e===1?"cambio pendiente":"cambios pendientes"} de sincronizaci\xF3n. Haz clic para sincronizar ahora.`;break;case"error":this.statusMessage="Error de sincronizaci\xF3n",this.tooltipMessage="Error al sincronizar cambios. Haz clic para reintentar.";break;case"offline":this.statusMessage="Modo offline",this.tooltipMessage="Trabajando en modo offline. Los cambios se sincronizar\xE1n cuando vuelvas online.";break;default:this.statusMessage="Desconocido",this.tooltipMessage="Estado de sincronizaci\xF3n desconocido."}}getStatusIcon(){if(!this.isOnline)return"cloud_off";switch(this.currentStatus){case"synced":return"cloud_done";case"syncing":return"sync";case"pending":return"cloud_queue";case"error":return"cloud_off";case"offline":return"cloud_off";default:return"help"}}getStatusColor(){if(!this.isOnline)return"warn";switch(this.currentStatus){case"synced":return"primary";case"syncing":return"accent";case"pending":return"accent";case"error":return"warn";case"offline":return"warn";default:return""}}triggerSync(){this.isOnline&&(this.currentStatus==="pending"||this.currentStatus==="error")&&this.syncService.forceSync()}static \u0275fac=function(t){return new(t||n)(g(w),g(m),g(h))};static \u0275cmp=U({type:n,selectors:[["app-sync-status"]],decls:4,vars:4,consts:[[1,"sync-status-container"],["mat-icon-button","","matBadgeColor","warn","matBadgeSize","small",3,"click","matTooltip","color","matBadge"]],template:function(t,i){t&1&&(x(0,"div",0)(1,"button",1),K("click",function(){return i.triggerSync()}),x(2,"mat-icon"),X(3),W()()()),t&2&&(M(),q("matTooltip",i.tooltipMessage)("color",i.getStatusColor())("matBadge",i.operationsCount>0?i.operationsCount:null),M(2),J(i.getStatusIcon()))},dependencies:[Q,te,ee,ae,se,ie,ne,oe,re],styles:[".sync-status-container[_ngcontent-%COMP%]{display:inline-block}button[matBadge][_ngcontent-%COMP%]{margin-right:8px}"]})};var It=[{path:"",redirectTo:"sync",pathMatch:"full"},{path:"sync",component:E}];export{It as OFFLINE_ROUTES};
