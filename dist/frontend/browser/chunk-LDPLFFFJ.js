import{a as S}from"./chunk-PYE7UGMK.js";import{c as u,f as l,g,ja as h,oa as b}from"./chunk-FG6FKNI4.js";import{a as d,b as c}from"./chunk-OXVY4BEJ.js";var p=class o{constructor(t){this.logger=t;this.logger.debug("WidgetStateService inicializado")}widgetStates=new Map;widgetErrors=new l;widgetErrors$=this.widgetErrors.asObservable();refreshWidgetsRequest=new l;refreshWidgetsRequest$=this.refreshWidgetsRequest.asObservable();_allStatesSubject=new g({});_isResizing=new g(!1);get allStates$(){return this._allStatesSubject.asObservable()}get isResizing$(){return this._isResizing.asObservable()}getWidgetState(t){return this.widgetStates.has(t)||this.widgetStates.set(t,new g({id:t,isVisible:!0,isCollapsed:!1,lastUpdated:new Date})),this.widgetStates.get(t).asObservable()}getCurrentWidgetState(t){return this.widgetStates.has(t)||this.getWidgetState(t),this.widgetStates.get(t).value}updateWidgetState(t,e){this.widgetStates.has(t)||this.getWidgetState(t);let s=this.widgetStates.get(t).value;this.widgetStates.get(t).next(c(d(d({},s),e),{lastUpdated:new Date}))}setWidgetVisibility(t,e){this.updateWidgetState(t,{isVisible:e})}toggleWidgetCollapse(t){let e=this.getCurrentWidgetState(t);this.updateWidgetState(t,{isCollapsed:!e.isCollapsed})}updateWidgetPosition(t,e){this.updateWidgetState(t,{position:e})}registerWidgetError(t,e){this.updateWidgetState(t,{hasError:!0,errorInfo:{code:e.code,message:e.message,timestamp:new Date}}),this.widgetErrors.next({widgetId:t,code:e.code,message:e.message,details:e.details,timestamp:new Date})}clearWidgetError(t){this.updateWidgetState(t,{hasError:!1,errorInfo:void 0})}refreshAllWidgetsData(t="system"){this.refreshWidgetsRequest.next({source:t})}refreshWidgetsData(t,e="system"){this.refreshWidgetsRequest.next({source:e,targets:t})}getVisibleWidgets(){return new u(t=>{let e=Array.from(this.widgetStates.values()).filter(i=>i.value.isVisible).map(i=>i.value.id);t.next(e);let s=Array.from(this.widgetStates.entries()).map(([i,r])=>r.subscribe(()=>{let n=Array.from(this.widgetStates.values()).filter(a=>a.value.isVisible).map(a=>a.value.id);t.next(n)}));return()=>{s.forEach(i=>i.unsubscribe())}})}resetAllWidgets(){this.widgetStates.forEach((t,e)=>{t.next({id:e,isVisible:!0,isCollapsed:!1,hasError:!1,lastUpdated:new Date})})}updateWidgetZIndex(t,e){this.updateWidgetState(t,{zIndex:e})}recalculateWidgetPositions(){this._isResizing.next(!0);let t=window.innerWidth,e=window.innerHeight,s=0,i=20,r=250,n=150;this.widgetStates.forEach((a,W)=>{let y=a.getValue(),m=Math.floor(s/3),v=s%3,f=i+v*(r+i),w=i+m*(n+i),x=Math.min(f,t-r-i),E=Math.min(w,e-n-i);this.updateWidgetPosition(W,{x,y:E}),s++}),this._isResizing.next(!1),this.logger.debug("Widget positions recalculated")}updateCombinedState(){let t={};this.widgetStates.forEach((e,s)=>{t[s]=e.getValue()}),this._allStatesSubject.next(t)}static \u0275fac=function(e){return new(e||o)(b(S))};static \u0275prov=h({token:o,factory:o.\u0275fac,providedIn:"root"})};export{p as a};
