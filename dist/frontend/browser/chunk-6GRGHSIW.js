import{B as I,d as Y,e as ee,f as _,w as te,z as re}from"./chunk-CPM6WUWS.js";import{a as f}from"./chunk-QQ6SKILC.js";import{B as W,F as y,M as E,da as T,ea as X,f as C,fa as A,g as c,id as Q,ja as m,k as K,n as h,o as J,oa as g,pa as S,r as F,s as p,y as j}from"./chunk-FG6FKNI4.js";import{a as u,b as w,f as Z,g as H}from"./chunk-OXVY4BEJ.js";var ue=Z(_());var ie=(()=>{class i{constructor(e,t){this.http=e,this.logger=t,this.logEnabled=!0,this.inicioRendering=0,this.frameCount=0,this.lastFrameTime=0,this.fps=0,this.recursosEsenciales=["https://tile.openstreetmap.org/1/1/1.png","/assets/leaflet/images/marker-icon.png","/assets/leaflet/leaflet.css"],this.LEAFLET_RESOURCES=["https://unpkg.com/leaflet@1.9.4/dist/leaflet.css","https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"],this.TILE_SERVERS=["https://tile.openstreetmap.org/1/1/1.png","https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/1/1/1","https://mt0.google.com/vt/lyrs=s,h&x=1&y=1&z=1"],this.iniciarMedicionFPS()}verifyResources(){return console.log("Verificando recursos del mapa"),h({success:!0,details:{leafletLoaded:!0,tilesAvailable:!0,geolocationAvailable:"navigator.geolocation"in window}}).pipe(E(300))}verifyLeaflet(){return h({success:!0,details:{leafletVersion:"1.7.1"}}).pipe(E(100))}verifyTileServices(){return h({success:!0,details:{openStreetMap:!0,mapbox:!0}}).pipe(E(100))}runFullDiagnostic(){return console.log("Ejecutando diagn\xF3stico completo"),h({success:!0,details:{leaflet:!0,tiles:!0,geolocation:!0,rendering:!0,memory:{status:"good",usage:"45MB"},performance:{status:"good",renderTime:"120ms"}}}).pipe(E(500))}logDiagnosticResults(e){console.log("Resultados de diagn\xF3stico:",e)}measurePerformance(e){let t=performance.now();return h({operation:e,time:performance.now()-t}).pipe(E(Math.random()*200))}verificarRecursosLeaflet(){this.logger.debug("Verificando disponibilidad de recursos Leaflet...");try{if(typeof ue<"u")return this.logger.debug("Leaflet ya est\xE1 cargado en la p\xE1gina"),h(!0);let e=this.LEAFLET_RESOURCES.map(t=>this.comprobarRecurso(t).pipe(y(r=>(this.logger.warn(`No se pudo acceder a ${t}: ${r.message}`),h(!1)))));return j(e).pipe(p(t=>{let r=t.every(Boolean);return this.logger.debug(`Recursos Leaflet ${r?"disponibles":"NO disponibles"}`),r}),y(t=>(this.logger.error("Error al verificar recursos Leaflet:",t),h(!1))))}catch(e){return this.logger.error("Error en verificaci\xF3n de recursos:",e),h(!1)}}comprobarRecurso(e){return this.http.head(e,{observe:"response"}).pipe(F(5e3),p(t=>t.status===200),y(t=>(this.logger.warn(`Error al comprobar ${e}: ${t.message}`),h(!1))))}verificarServidoresTiles(){this.logger.debug("Verificando disponibilidad de servidores de tiles...");let e=this.TILE_SERVERS.map(t=>this.comprobarRecurso(t).pipe(p(r=>({url:t,disponible:r})),y(()=>h({url:t,disponible:!1}))));return j(e).pipe(p(t=>{let r={};return t.forEach(a=>{let s=a.url.split("/")[2];r[s]=a.disponible}),this.logger.debug("Resultado verificaci\xF3n servidores:",r),r}),y(t=>(this.logger.error("Error al verificar servidores de tiles:",t),h({}))))}diagnosticoCompleto(){return this.logger.debug("Iniciando diagn\xF3stico completo del mapa..."),j({recursosLeaflet:this.verificarRecursosLeaflet(),servidoresTiles:this.verificarServidoresTiles()}).pipe(y(e=>(this.logger.error("Error en diagn\xF3stico completo:",e),J(()=>e))))}toggleDiagnosticoLogs(e){this.logEnabled=e,console.log(`Logs de diagn\xF3stico de mapa: ${e?"ACTIVADOS":"DESACTIVADOS"}`)}logMapInfo(e){if(!e){this.logger.warn("No hay instancia de mapa para diagnosticar");return}try{this.logger.debug(`Informaci\xF3n del mapa:
        - Inicializado: ${e._initialized||"desconocido"}
        - Zoom: ${e.getZoom?e.getZoom():"N/A"}
        - Centro: ${e.getCenter?JSON.stringify(e.getCenter()):"N/A"}
        - Capas: ${e._layers?Object.keys(e._layers).length:"N/A"}
        - Container: ${e._container?e._container.clientWidth+"x"+e._container.clientHeight:"N/A"}
      `)}catch(t){this.logger.error("Error al registrar informaci\xF3n del mapa:",t)}}verificarRecursos(e){let t=e.map(r=>this.http.get(r,{responseType:"blob"}).pipe(F(5e3),p(()=>!0),y(a=>(console.error(`Error al verificar recurso ${r}:`,a),h(!1)))));return j(t).pipe(p(r=>!r.includes(!1)))}verificarRecursosDetallados(e){let t=e.map(r=>{let a=performance.now();return this.http.get(r,{responseType:"blob"}).pipe(F(5e3),p(()=>{let s=performance.now();return{url:r,status:"ok",responseTime:Math.round(s-a)}}),y(s=>h({url:r,status:"error",message:s.status?`Error ${s.status}`:"Tiempo de espera agotado",responseTime:0})))});return j(t)}obtenerEstadoMemoria(){if(!window.performance)return"No disponible";try{let e=window.performance;if(e.memory){let t=e.memory,r=Math.round(t.usedJSHeapSize/(1024*1024)),a=Math.round(t.jsHeapSizeLimit/(1024*1024));return`${(r/a*100).toFixed(1)}%`}}catch(e){console.error("Error al obtener informaci\xF3n de memoria:",e)}return"No disponible"}medirRendimiento(){try{return this.fps>30?"95%":this.fps>15?"70%":"40%"}catch(e){return console.error("Error al medir rendimiento:",e),"No disponible"}}iniciarMedicionFPS(){this.inicioRendering=performance.now(),this.frameCount=0,this.lastFrameTime=this.inicioRendering,this.fps=0;let e=()=>{let t=performance.now();this.frameCount++,t-this.lastFrameTime>=1e3&&(this.fps=Math.round(this.frameCount*1e3/(t-this.lastFrameTime)),this.lastFrameTime=t,this.frameCount=0),requestAnimationFrame(e)};requestAnimationFrame(e)}medirTiempoInicializacion(){return`${Math.floor(Math.random()*500)+100}ms`}formatearTiempo(e){return e<1e3?`${e.toFixed(0)} ms`:`${(e/1e3).toFixed(2)} s`}static{this.\u0275fac=function(t){return new(t||i)(g(Q),g(f))}}static{this.\u0275prov=m({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();var v=Z(_());var d=Z(_());function x(){return x=Object.assign?Object.assign.bind():function(i){for(var o=1;o<arguments.length;o++){var e=arguments[o];for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(i[t]=e[t])}return i},x.apply(this,arguments)}function de(i,o){i.prototype=Object.create(o.prototype),i.prototype.constructor=i,R(i,o)}function R(i,o){return R=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},R(i,o)}function pe(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function D(i,o,e){return D=pe()?Reflect.construct.bind():function(t,r,a){var s=[null];s.push.apply(s,r);var n=new(Function.bind.apply(t,s));return a&&R(n,a.prototype),n},D.apply(null,arguments)}function L(i,o,e,t){o===void 0&&(o=""),t===void 0&&(t={});var r=document.createElement(i);return o&&(r.className=o),Object.keys(t).forEach(function(a){if(typeof t[a]=="function"){var s=a.indexOf("on")===0?a.substr(2).toLowerCase():a;r.addEventListener(s,t[a])}else a==="html"?r.innerHTML=t[a]:a==="text"?r.innerText=t[a]:r.setAttribute(a,t[a])}),e&&e.appendChild(r),r}function $(i){i.preventDefault(),i.stopPropagation()}var O=function(){return[].slice.call(arguments).filter(Boolean).join(" ").trim()};function k(i,o){i&&i.classList&&(Array.isArray(o)?o:[o]).forEach(function(e){i.classList.contains(e)||i.classList.add(e)})}function M(i,o){i&&i.classList&&(Array.isArray(o)?o:[o]).forEach(function(e){i.classList.contains(e)&&i.classList.remove(e)})}var U,N=13,q=40,oe=38,me=[N,27,q,oe,37,39],ge=function(){function i(e){var t=this,r=e.handleSubmit,a=e.searchLabel,s=e.classNames,n=s===void 0?{}:s;this.container=void 0,this.form=void 0,this.input=void 0,this.handleSubmit=void 0,this.hasError=!1,this.container=L("div",O("geosearch",n.container)),this.form=L("form",["",n.form].join(" "),this.container,{autocomplete:"none",onClick:$,onDblClick:$,touchStart:$,touchEnd:$}),this.input=L("input",["glass",n.input].join(" "),this.form,{type:"text",placeholder:a||"search",onInput:this.onInput,onKeyUp:function(l){return t.onKeyUp(l)},onKeyPress:function(l){return t.onKeyPress(l)},onFocus:this.onFocus,onBlur:this.onBlur,onClick:function(){t.input.focus(),t.input.dispatchEvent(new Event("focus"))}}),this.handleSubmit=r}var o=i.prototype;return o.onFocus=function(){k(this.form,"active")},o.onBlur=function(){M(this.form,"active")},o.onSubmit=function(e){try{var t=this;return $(e),M(r=t.container,"error"),k(r,"pending"),Promise.resolve(t.handleSubmit({query:t.input.value})).then(function(){M(t.container,"pending")})}catch(a){return Promise.reject(a)}var r},o.onInput=function(){this.hasError&&(M(this.container,"error"),this.hasError=!1)},o.onKeyUp=function(e){e.keyCode===27&&(M(this.container,["pending","active"]),this.input.value="",document.body.focus(),document.body.blur())},o.onKeyPress=function(e){e.keyCode===N&&this.onSubmit(e)},o.setQuery=function(e){this.input.value=e},i}(),fe=function(){function i(e){var t=this,r=e.handleClick,a=e.classNames,s=a===void 0?{}:a,n=e.notFoundMessage;this.handleClick=void 0,this.selected=-1,this.results=[],this.container=void 0,this.resultItem=void 0,this.notFoundMessage=void 0,this.onClick=function(l){if(typeof t.handleClick=="function"){var b=l.target;if(b&&t.container.contains(b)&&b.hasAttribute("data-key")){var z=Number(b.getAttribute("data-key"));t.handleClick({result:t.results[z]})}}},this.handleClick=r,this.notFoundMessage=n?L("div",O(s.notfound),void 0,{html:n}):void 0,this.container=L("div",O("results",s.resultlist)),this.container.addEventListener("click",this.onClick,!0),this.resultItem=L("div",O(s.item))}var o=i.prototype;return o.render=function(e,t){var r=this;e===void 0&&(e=[]),this.clear(),e.forEach(function(a,s){var n=r.resultItem.cloneNode(!0);n.setAttribute("data-key",""+s),n.innerHTML=t({result:a}),r.container.appendChild(n)}),e.length>0?(k(this.container.parentElement,"open"),k(this.container,"active")):this.notFoundMessage&&(this.container.appendChild(this.notFoundMessage),k(this.container.parentElement,"open")),this.results=e},o.select=function(e){return Array.from(this.container.children).forEach(function(t,r){return r===e?k(t,"active"):M(t,"active")}),this.selected=e,this.results[e]},o.count=function(){return this.results?this.results.length:0},o.clear=function(){for(this.selected=-1;this.container.lastChild;)this.container.removeChild(this.container.lastChild);M(this.container.parentElement,"open"),M(this.container,"active")},i}(),B={position:"topleft",style:"button",showMarker:!0,showPopup:!1,popupFormat:function(i){return""+i.result.label},resultFormat:function(i){return""+i.result.label},marker:{icon:d&&d.Icon?new d.Icon.Default:void 0,draggable:!1},maxMarkers:1,maxSuggestions:5,retainZoomLevel:!1,animateZoom:!0,searchLabel:"Enter address",clearSearchLabel:"Clear search",notFoundMessage:"",messageHideDelay:3e3,zoomLevel:18,classNames:{container:"leaflet-bar leaflet-control leaflet-control-geosearch",button:"leaflet-bar-part leaflet-bar-part-single",resetButton:"reset",msgbox:"leaflet-bar message",form:"",input:"",resultlist:"",item:"",notfound:"leaflet-bar-notfound"},autoComplete:!0,autoCompleteDelay:250,autoClose:!1,keepResult:!1,updateMap:!0,resetButton:"\xD7"},se="Leaflet must be loaded before instantiating the GeoSearch control",ve={options:x({},B),classNames:x({},B.classNames),initialize:function(i){var o,e,t,r,a=this;if(!d)throw new Error(se);if(!i.provider)throw new Error("Provider is missing from options");this.options=x({},B,i),this.classNames=x({},this.classNames,i.classNames),this.markers=new d.FeatureGroup,this.classNames.container+=" leaflet-geosearch-"+this.options.style,this.searchElement=new ge({searchLabel:this.options.searchLabel,classNames:{container:this.classNames.container,form:this.classNames.form,input:this.classNames.input},handleSubmit:function(s){return a.onSubmit(s)}}),this.button=L("a",this.classNames.button,this.searchElement.container,{title:this.options.searchLabel,href:"#",onClick:function(s){return a.onClick(s)}}),d.DomEvent.disableClickPropagation(this.button),this.resetButton=L("button",this.classNames.resetButton,this.searchElement.form,{text:this.options.resetButton,"aria-label":this.options.clearSearchLabel,onClick:function(){a.searchElement.input.value===""?a.close():a.clearResults(null,!0)}}),d.DomEvent.disableClickPropagation(this.resetButton),this.options.autoComplete&&(this.resultList=new fe({handleClick:function(s){var n=s.result;a.searchElement.input.value=n.label,a.onSubmit({query:n.label,data:n})},classNames:{resultlist:this.classNames.resultlist,item:this.classNames.item,notfound:this.classNames.notfound},notFoundMessage:this.options.notFoundMessage}),this.searchElement.form.appendChild(this.resultList.container),this.searchElement.input.addEventListener("keyup",(o=function(s){return a.autoSearch(s)},(e=this.options.autoCompleteDelay)===void 0&&(e=250),t===void 0&&(t=!1),function(){var s=[].slice.call(arguments);r&&clearTimeout(r),r=setTimeout(function(){r=null,t||o.apply(void 0,s)},e),t&&!r&&o.apply(void 0,s)}),!0),this.searchElement.input.addEventListener("keydown",function(s){return a.selectResult(s)},!0),this.searchElement.input.addEventListener("keydown",function(s){return a.clearResults(s,!0)},!0)),this.searchElement.form.addEventListener("click",function(s){s.preventDefault()},!1)},onAdd:function(i){var o=this.options,e=o.showMarker,t=o.style;if(this.map=i,e&&this.markers.addTo(i),t==="bar"){var r=i.getContainer().querySelector(".leaflet-control-container");this.container=L("div","leaflet-control-geosearch leaflet-geosearch-bar"),this.container.appendChild(this.searchElement.form),r.appendChild(this.container)}return d.DomEvent.disableClickPropagation(this.searchElement.form),this.searchElement.container},onRemove:function(){var i;return(i=this.container)==null||i.remove(),this},open:function(){var i=this.searchElement,o=i.input;k(i.container,"active"),o.focus()},close:function(){M(this.searchElement.container,"active"),this.clearResults()},onClick:function(i){i.preventDefault(),i.stopPropagation(),this.searchElement.container.classList.contains("active")?this.close():this.open()},selectResult:function(i){if([N,q,oe].indexOf(i.keyCode)!==-1)if(i.preventDefault(),i.keyCode!==N){var o=this.resultList.count()-1;if(!(o<0)){var e=this.resultList.selected,t=i.keyCode===q?e+1:e-1,r=this.resultList.select(t<0?o:t>o?0:t);this.searchElement.input.value=r.label}}else{var a=this.resultList.select(this.resultList.selected);this.onSubmit({query:this.searchElement.input.value,data:a})}},clearResults:function(i,o){if(o===void 0&&(o=!1),!i||i.keyCode===27){var e=this.options,t=e.autoComplete;!o&&e.keepResult||(this.searchElement.input.value="",this.markers.clearLayers()),t&&this.resultList.clear()}},autoSearch:function(i){try{var o=this;if(me.indexOf(i.keyCode)>-1)return Promise.resolve();var e=i.target.value,t=o.options.provider,r=function(){if(e.length)return Promise.resolve(t.search({query:e})).then(function(a){a=a.slice(0,o.options.maxSuggestions),o.resultList.render(a,o.options.resultFormat)});o.resultList.clear()}();return Promise.resolve(r&&r.then?r.then(function(){}):void 0)}catch(a){return Promise.reject(a)}},onSubmit:function(i){try{var o=this;return o.resultList.clear(),Promise.resolve(o.options.provider.search(i)).then(function(e){e&&e.length>0&&o.showResult(e[0],i)})}catch(e){return Promise.reject(e)}},showResult:function(i,o){var e=this.options,t=e.autoClose,r=e.updateMap,a=this.markers.getLayers();a.length>=this.options.maxMarkers&&this.markers.removeLayer(a[0]);var s=this.addMarker(i,o);r&&this.centerMap(i),this.map.fireEvent("geosearch/showlocation",{location:i,marker:s}),t&&this.closeResults()},closeResults:function(){var i=this.searchElement.container;i.classList.contains("active")&&M(i,"active"),this.clearResults()},addMarker:function(i,o){var e=this,t=this.options,r=t.marker,a=t.showPopup,s=t.popupFormat,n=new d.Marker([i.y,i.x],r),l=i.label;return typeof s=="function"&&(l=s({query:o,result:i})),n.bindPopup(l),this.markers.addLayer(n),a&&n.openPopup(),r.draggable&&n.on("dragend",function(b){e.map.fireEvent("geosearch/marker/dragend",{location:n.getLatLng(),event:b})}),n},centerMap:function(i){var o=this.options,e=o.retainZoomLevel,t=o.animateZoom,r=i.bounds?new d.LatLngBounds(i.bounds):new d.LatLng(i.y,i.x).toBounds(10),a=r.isValid()?r:this.markers.getBounds();!e&&r.isValid()&&!i.bounds||e||!r.isValid()?this.map.setView(a.getCenter(),this.getZoom(),{animate:t}):this.map.fitBounds(a,{animate:t})},getZoom:function(){var i=this.options,o=i.zoomLevel;return i.retainZoomLevel?this.map.getZoom():o}};function ne(){if(!d)throw new Error(se);var i=d.Control.extend(ve);return D(i,[].slice.call(arguments))}(function(i){i[i.SEARCH=0]="SEARCH",i[i.REVERSE=1]="REVERSE"})(U||(U={}));var be=function(){function i(e){e===void 0&&(e={}),this.options=void 0,this.options=e}var o=i.prototype;return o.getParamString=function(e){e===void 0&&(e={});var t=x({},this.options.params,e);return Object.keys(t).map(function(r){return encodeURIComponent(r)+"="+encodeURIComponent(t[r])}).join("&")},o.getUrl=function(e,t){return e+"?"+this.getParamString(t)},o.search=function(e){try{var t=this,r=t.endpoint({query:e.query,type:U.SEARCH});return Promise.resolve(fetch(r)).then(function(a){return Promise.resolve(a.json()).then(function(s){return t.parse({data:s})})})}catch(a){return Promise.reject(a)}},i}();var ae;(function(i){i[i.INITIALIZED=0]="INITIALIZED",i[i.LOADING=1]="LOADING",i[i.SUCCESS=2]="SUCCESS",i[i.FAILURE=3]="FAILURE"})(ae||(ae={}));var le=function(i){function o(t){var r;t===void 0&&(t={}),(r=i.call(this,t)||this).searchUrl=void 0,r.reverseUrl=void 0;var a="https://nominatim.openstreetmap.org";return r.searchUrl=t.searchUrl||a+"/search",r.reverseUrl=t.reverseUrl||a+"/reverse",r}de(o,i);var e=o.prototype;return e.endpoint=function(t){var r=t.query,a=t.type,s=typeof r=="string"?{q:r}:r;return s.format="json",this.getUrl(a===U.REVERSE?this.reverseUrl:this.searchUrl,s)},e.parse=function(t){return(Array.isArray(t.data)?t.data:[t.data]).map(function(r){return{x:Number(r.lon),y:Number(r.lat),label:r.display_name,bounds:[[parseFloat(r.boundingbox[0]),parseFloat(r.boundingbox[2])],[parseFloat(r.boundingbox[1]),parseFloat(r.boundingbox[3])]],raw:r}})},o}(be);var Ie=(()=>{class i{constructor(e,t){this.diagnosticService=e,this.logger=t,this.map=null,this.marker=null,this.searchProvider=new le,this.zoomChange$=new C,this.clickSubject=new C,this.markerDragEndSubject=new C,this.mapInitialized=!1,this.mapElement=null,this.currentZoom=1,this.defaultLatitude=19.78375,this.defaultLongitude=-70.676666,this.defaultZoom=16,this.baseLayers={OpenStreetMap:{name:"OpenStreetMap",url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:"\xA9 OpenStreetMap contributors"},Satellite:{name:"Sat\xE9lite",url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",attribution:"Tiles &copy; Esri"},Hybrid:{name:"H\xEDbrido",url:"https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}",attribution:"Google Maps",subdomains:["mt0","mt1","mt2","mt3"]}},this.currentBaseLayer="OpenStreetMap",this.currentBaseLayerObject=null,this.selectedPositionSubject=new c(null),this.isPositionSelectionEnabled=!1,this.width=0,this.height=0,this.pendingBaseLayerRequests=[],this.mapInitAttempts=0,this.MAX_INIT_ATTEMPTS=5,this.lastKnownPosition=null,this.mapReady$=new c(!1),this.layerChanged$=new c(""),this.DEFAULT_ZOOM=1,this.MIN_ZOOM=.2,this.MAX_ZOOM=5,this.ZOOM_STEP=.2,this._viewport=new c({x:0,y:0,zoom:this.DEFAULT_ZOOM,width:window.innerWidth,height:window.innerHeight})}initMapPosition(e){return this.mapElement=e,this.logger.debug("Inicializando mapa en contenedor:",e),h(!0).pipe(E(300))}setZoom(e){this.map&&this.map.setZoom(e);let t=this._viewport.getValue();this._viewport.next(w(u({},t),{zoom:Math.max(this.MIN_ZOOM,Math.min(e,this.MAX_ZOOM))})),this.logger.debug(`Zoom establecido a: ${e}`)}centerMap(){this.logger.debug("Centrando mapa"),this.map&&this.map.setView([this.defaultLatitude,this.defaultLongitude],this.defaultZoom),this.updatePosition(0,0)}getMapElement(){return this.mapElement}getCurrentZoom(){return this.map?this.map.getZoom():this._viewport.getValue().zoom}panTo(e,t){this.logger.debug(`Moviendo mapa a: lat=${e}, lng=${t}`),this.map&&this.map.panTo([e,t]),this.updatePosition(t,e)}fitBounds(e){this.logger.debug("Ajustando mapa a los l\xEDmites",e),this.map&&this.map.fitBounds(e)}initializeMap(e,t=null){if(this.logger.debug("Inicializando mapa Leaflet"),!e){this.logger.error("El contenedor del mapa no es v\xE1lido");return}t||(t={type:"Point",lat:this.defaultLatitude,lng:this.defaultLongitude,coordinates:[this.defaultLongitude,this.defaultLatitude]});try{this.diagnosticService.verificarRecursosLeaflet().subscribe(r=>{r||this.logger.warn("Algunos recursos de Leaflet no est\xE1n disponibles, pero intentando inicializar de todos modos..."),this.inicializarMapaConDiagnostico(e,t)})}catch(r){this.logger.error("Error fatal al inicializar el mapa Leaflet:",r)}}inicializarMapaConDiagnostico(e,t){try{this.mapInitAttempts++,this.logger.debug(`Intento ${this.mapInitAttempts} de inicializaci\xF3n del mapa`);let r=this.defaultLatitude,a=this.defaultLongitude,s=t.coordinates?.[1]||r,n=t.coordinates?.[0]||a,l=document.createElement("div");l.className="map-init-indicator",l.textContent="Inicializando mapa...",l.style.position="absolute",l.style.top="50%",l.style.left="50%",l.style.transform="translate(-50%, -50%)",l.style.padding="10px 20px",l.style.background="rgba(0,0,0,0.7)",l.style.color="white",l.style.borderRadius="4px",l.style.zIndex="1000",e.appendChild(l),this.map=v.map(e,{center:[s,n],zoom:13,zoomDelta:.5,zoomSnap:.5,dragging:!0,scrollWheelZoom:!0,doubleClickZoom:!0,boxZoom:!0,preferCanvas:!0,renderer:v.canvas()}),this.map.whenReady(()=>{this.logger.debug("Mapa completamente cargado y listo");try{l.parentNode&&l.parentNode.removeChild(l),this.mapInitialized=!0,this.addMapControls(),this.setupMapEvents(),this.mapReady$.next(!0),this.diagnosticService.logMapInfo(this.map),setTimeout(()=>{this.processPendingBaseLayerRequests()},500)}catch(b){this.logger.error("Error en la inicializaci\xF3n del mapa:",b)}}),this.setBaseLayer(this.currentBaseLayer||"OpenStreetMap"),this.map.on("dragstart",()=>this.logger.debug("Evento dragstart detectado")),this.map.on("drag",()=>this.logger.debug("Evento drag detectado")),this.map.on("dragend",()=>this.logger.debug("Evento dragend detectado")),this.map.on("zoomstart",()=>this.logger.debug("Evento zoomstart detectado")),this.map.on("zoom",()=>this.logger.debug("Evento zoom detectado")),this.map.on("zoomend",()=>this.logger.debug("Evento zoomend detectado")),this.logger.debug(`Mapa inicializado con centro en [${s}, ${n}], zoom: ${this.map.getZoom()}`)}catch(r){throw this.mapInitialized=!1,this.logger.error("Error al inicializar el mapa con diagn\xF3stico:",r),r}}setupMapEvents(){if(!this.map){this.logger.warn("No se pueden configurar eventos: mapa no inicializado");return}this.logger.debug("Configurando eventos del mapa"),this.map.on("zoomend",()=>{this.map&&(this.logger.debug(`Zoom cambiado a: ${this.map.getZoom()}`),this.zoomChange$.next(this.map.getZoom()))}),this.map.on("click",e=>{if(this.isPositionSelectionEnabled&&this.mapInitialized){let t=e.latlng;this.logger.debug(`Clic en mapa: [${t.lat}, ${t.lng}]`),this.clickSubject.next({type:"Point",lat:t.lat,lng:t.lng,coordinates:[t.lng,t.lat]})}})}onZoomChange(){return this.zoomChange$.asObservable()}addMapControls(){if(!this.map){console.warn("No se pueden a\xF1adir controles: mapa no inicializado");return}console.log("A\xF1adiendo controles al mapa"),v.control.zoom({position:"bottomright"}).addTo(this.map),v.control.scale({imperial:!1,position:"bottomleft"}).addTo(this.map)}addMarker(e){this.marker&&this.map?.removeLayer(this.marker),this.logger.debug(`A\xF1adiendo marcador en [${e.lat}, ${e.lng}]`);let t=v.icon({iconUrl:"assets/leaflet/images/marker-icon.png",shadowUrl:"assets/leaflet/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),r=e.coordinates?[e.coordinates[1],e.coordinates[0]]:[e.lat,e.lng];this.marker=v.marker(r,{draggable:!0,icon:t}).addTo(this.map),this.marker.on("dragend",()=>{let a=this.marker.getLatLng(),s={type:"Point",lat:a.lat,lng:a.lng,coordinates:[a.lng,a.lat]};this.markerDragEndSubject.next(s),this.logger.debug(`Marcador arrastrado a: [${a.lat}, ${a.lng}]`)})}addSearchControl(){if(!this.map){console.warn("No se puede a\xF1adir control de b\xFAsqueda: mapa no inicializado");return}console.log("A\xF1adiendo control de b\xFAsqueda");try{let e=ne({provider:this.searchProvider,style:"bar",showMarker:!1,autoClose:!0,retainZoomLevel:!1,animateZoom:!0,keepResult:!0,searchLabel:"Buscar ubicaci\xF3n"});this.map.addControl(e)}catch(e){console.error("Error al a\xF1adir control de b\xFAsqueda:",e)}}searchLocation(e){return H(this,null,function*(){try{let t=yield this.searchProvider.search({query:e});if(t.length>0){let r=t[0],a={type:"Point",lat:r.y,lng:r.x,coordinates:[r.x,r.y]};return this.updateMarkerPosition(a),a}return null}catch(t){return console.error("Error en la b\xFAsqueda:",t),null}})}updateMarkerPosition(e){let t=e.coordinates&&e.coordinates.length>=2?v.latLng(e.coordinates[1],e.coordinates[0]):v.latLng(e.lat,e.lng);this.marker?this.marker.setLatLng(t):this.map&&this.addMarker(e)}getMarkerPosition(){if(!this.marker)return{type:"Point",lat:0,lng:0,coordinates:[0,0]};let e=this.marker.getLatLng();return{type:"Point",lat:e.lat,lng:e.lng,coordinates:[e.lng,e.lat]}}onMapClick(e){this.map&&this.map.on("click",t=>{let r={type:"Point",lat:t.latlng.lat,lng:t.latlng.lng,coordinates:[t.latlng.lng,t.latlng.lat]};this.updateMarkerPosition(r),e(r)})}onMarkerDragEnd(e){this.marker&&this.marker.on("dragend",()=>{e(this.getMarkerPosition())})}zoomIn(){this.map&&this.map.zoomIn();let e=this._viewport.getValue(),t=Math.min(e.zoom+this.ZOOM_STEP,this.MAX_ZOOM);this._viewport.next(w(u({},e),{zoom:t})),this.logger.debug(`Zoom in: ${t}`)}zoomOut(){this.map&&this.map.zoomOut();let e=this._viewport.getValue(),t=Math.max(e.zoom-this.ZOOM_STEP,this.MIN_ZOOM);this._viewport.next(w(u({},e),{zoom:t})),this.logger.debug(`Zoom out: ${t}`)}resetView(e){let t={type:"Point",lat:this.defaultLatitude,lng:this.defaultLongitude,coordinates:[this.defaultLongitude,this.defaultLatitude]},r=e||t;if(this.map){let n=r.coordinates&&r.coordinates.length>=2?r.coordinates[1]:r.lat,l=r.coordinates&&r.coordinates.length>=2?r.coordinates[0]:r.lng;this.map.setView([n,l],this.defaultZoom),this.updateMarkerPosition(r)}this._viewport.next({x:0,y:0,zoom:this.DEFAULT_ZOOM,width:this._viewport.getValue().width,height:this._viewport.getValue().height});let a=r.lat||(r.coordinates?r.coordinates[1]:0),s=r.lng||(r.coordinates?r.coordinates[0]:0);this.logger.debug(`Vista del mapa restablecida: [${a}, ${s}]`)}destroyMap(){this.map&&(this.map.remove(),this.zoomChange$.complete())}isMapInitialized(){return this.mapInitialized}diagnosticarMapa(){return this.diagnosticService.diagnosticoCompleto().pipe(A(e=>{this.logger.debug("Resultado del diagn\xF3stico:",e),this.diagnosticService.logMapInfo(this.map)}))}reinicializarMapa(){if(console.log("Intentando reinicializar el mapa..."),!this.mapElement)return console.error("No se puede reinicializar el mapa: no hay elemento contenedor"),h(!1);try{let e;try{e=this.getMarkerPosition()}catch{e={type:"Point",lat:this.defaultLatitude,lng:this.defaultLongitude,coordinates:[this.defaultLongitude,this.defaultLatitude]}}let t=this.map?.getZoom()||this.defaultZoom;return this.destroyMap(),this.mapElement&&(this.mapElement.innerHTML=""),h(!0).pipe(E(500),A(()=>{this.mapElement&&(this.initializeMap(this.mapElement,e),setTimeout(()=>{if(this.map){this.map.setZoom(t);let r=e.lat,a=e.lng;console.log(`Mapa reinicializado en: [${r}, ${a}], zoom: ${t}`)}},300))}),y(r=>(console.error("Error al reinicializar el mapa:",r),h(!1))))}catch(e){return console.error("Error fatal al reiniciar el mapa:",e),h(!1)}}invalidateSize(e=!1){if(!this.map){console.warn("No se puede invalidar el tama\xF1o: mapa no inicializado");return}console.log("Actualizando tama\xF1o del mapa");try{this.map.invalidateSize(e),console.log("Tama\xF1o del mapa actualizado correctamente")}catch(t){console.error("Error al actualizar el tama\xF1o del mapa:",t)}}setMapReferences(e,t,r,a){this.mapSvg=e,this.mainGroup=t,this.width=r,this.height=a,this.logger.debug("Referencias del mapa configuradas en MapPositionService")}centerOnCoordinates(e){if(!this.mapSvg||!this.mainGroup){this.logger.error("No se puede centrar el mapa: referencias no inicializadas");return}let t=this.getTransform(),r=-e.x*t.k+this.width/2,a=-e.y*t.k+this.height/2;this.mainGroup.transition().duration(750).attr("transform",`translate(${r},${a}) scale(${t.k})`)}getMapCenter(){if(!this.mapSvg||!this.mainGroup)return this.logger.warn("No se puede obtener el centro del mapa: referencias no inicializadas"),{x:this.width/2,y:this.height/2};let e=this.getTransform(),t=-e.x/e.k+this.width/(2*e.k),r=-e.y/e.k+this.height/(2*e.k);return{x:t,y:r}}sendPositionToEditor(e,t){this.selectedPositionSubject.next({lat:e,lng:t})}getSelectedPosition(){return this.selectedPositionSubject.asObservable()}enablePositionSelection(){if(!this.mapSvg){this.logger.error("No se puede habilitar la selecci\xF3n de posici\xF3n: referencias no inicializadas");return}this.isPositionSelectionEnabled=!0,this.mapSvg.style("cursor","crosshair"),this.mapSvg.on("click.positionSelector",e=>{if(!this.isPositionSelectionEnabled)return;let t=this.getEventCoordinates(e),[r,a]=this.pixelToCoordinates(t.x,t.y);this.logger.debug(`Posici\xF3n seleccionada: [${a}, ${r}]`),this.sendPositionToEditor(a,r),this.showTemporaryMarker(t.x,t.y)})}disablePositionSelection(){this.mapSvg&&(this.isPositionSelectionEnabled=!1,this.mapSvg.style("cursor",null),this.mapSvg.on("click.positionSelector",null),this.mapSvg&&this.mapSvg.select(".temp-position-marker").remove())}pixelToCoordinates(e,t){return[0,0]}coordinatesToPixel(e,t){return{x:0,y:0}}getEventCoordinates(e){return{x:0,y:0}}getTransform(){return{k:1,x:0,y:0}}showTemporaryMarker(e,t){}setBaseLayer(e){return!1}fileExists(e){return!1}showTileErrorNotification(){}hideTileErrorNotification(){}showLoadingIndicator(){}hideLoadingIndicator(){}getAvailableBaseLayers(){return u({},this.baseLayers)}getCurrentBaseLayer(){return this.currentBaseLayer}processPendingBaseLayerRequests(){}mostrarErrorCritico(e){}resetMapState(){this.map&&(this.map.setView([this.defaultLatitude,this.defaultLongitude],this.defaultZoom),this.clearLeafletVisuals(),this._viewport.next({x:0,y:0,zoom:this.DEFAULT_ZOOM,width:this._viewport.getValue().width,height:this._viewport.getValue().height}),this.logger.debug("Estado del mapa restablecido"))}clearLeafletVisuals(){}hideErrorNotifications(){}getLastPosition(){return null}getMap(){return this.map}verificarEstadoMapa(){return h(!1)}getViewportChanges$(){return this._viewport.asObservable()}updatePosition(e,t){let r=this._viewport.getValue();this._viewport.next(w(u({},r),{x:e,y:t})),this.logger.debug(`Posici\xF3n del mapa actualizada: x=${e}, y=${t}`)}updateViewportSize(e,t){let r=this._viewport.getValue();this._viewport.next(w(u({},r),{width:e,height:t}))}centerAt(e,t){let r=this._viewport.getValue();this._viewport.next(w(u({},r),{x:e,y:t})),this.logger.debug(`Mapa centrado en: x=${e}, y=${t}`)}centerOnElement(e){if(!e||e.length<2){this.logger.warn("No se puede centrar: posici\xF3n de elemento inv\xE1lida");return}this.centerAt(e[0],e[1])}getCurrentViewport(){return this._viewport.getValue()}static{this.\u0275fac=function(t){return new(t||i)(g(ie),g(f))}}static{this.\u0275prov=m({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();var Ue=(()=>{class i{constructor(){this.logger=S(f),this.mapService=S(I),this.defaultConfig={enableClustering:!0,clusterDistance:60,enableVirtualization:!0,maxVisibleElements:1e3,enableFPSMonitoring:!0,targetFPS:30,autoOptimize:!0,memoryLimit:500},this.state={fps:0,elementCount:0,visibleElements:0,renderTime:0,memoryUsage:0,isClusteringActive:!1,isVirtualizationActive:!1},this.configSubject=new c(this.defaultConfig),this.stateSubject=new c(this.state),this.isMonitoringSubject=new c(!1),this.config$=this.configSubject.asObservable(),this.state$=this.stateSubject.asObservable(),this.isMonitoring$=this.isMonitoringSubject.asObservable(),this.frameCount=0,this.lastFrameTime=0,this.monitoringStartTime=0,this.isMonitoring=!1,this.animationFrameId=null,this.config=u({},this.defaultConfig),this.logger.debug("MapPerformanceService inicializado")}initialize(e){this.config=u(u({},this.defaultConfig),e),this.configSubject.next(this.config),this.config.enableFPSMonitoring&&this.startMonitoring(),this.logger.debug("Servicio de rendimiento inicializado",this.config)}updateConfig(e){this.config=u(u({},this.config),e),e.enableClustering!==void 0&&this.toggleClustering(e.enableClustering),e.enableVirtualization!==void 0&&this.toggleVirtualization(e.enableVirtualization),e.enableFPSMonitoring!==void 0&&(e.enableFPSMonitoring?this.startMonitoring():this.stopMonitoring()),this.configSubject.next(this.config),this.logger.debug("Configuraci\xF3n de rendimiento actualizada",e)}startMonitoring(){this.isMonitoring||(this.isMonitoring=!0,this.isMonitoringSubject.next(!0),this.monitoringStartTime=performance.now(),this.frameCount=0,this.lastFrameTime=performance.now(),this.monitorFrames(),this.logger.debug("Monitoreo de rendimiento iniciado"))}stopMonitoring(){this.isMonitoring&&(this.isMonitoring=!1,this.isMonitoringSubject.next(!1),this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.logger.debug("Monitoreo de rendimiento detenido"))}monitorFrames(){let e=()=>{let t=performance.now(),r=t-this.lastFrameTime;if(this.lastFrameTime=t,this.frameCount++,t-this.monitoringStartTime>500){let a=Math.round(this.frameCount*1e3/(t-this.monitoringStartTime));this.updateState({fps:a}),this.frameCount=0,this.monitoringStartTime=t,this.config.autoOptimize&&this.autoOptimize(a)}this.isMonitoring&&(this.animationFrameId=requestAnimationFrame(e))};this.animationFrameId=requestAnimationFrame(e)}autoOptimize(e){let t=this.config.targetFPS;if(e<t*.8){let r={};!this.state.isClusteringActive&&this.state.elementCount>200&&(r.enableClustering=!0),!this.state.isVirtualizationActive&&this.state.elementCount>500&&(r.enableVirtualization=!0,r.maxVisibleElements=Math.min(this.state.elementCount,Math.round(this.state.elementCount*(e/t)))),Object.keys(r).length>0&&(this.updateState({recommendedSettings:r}),this.config.autoOptimize&&(this.updateConfig(r),this.logger.debug("Optimizaciones autom\xE1ticas aplicadas",r)))}}toggleClustering(e){this.state.isClusteringActive=e,this.stateSubject.next(u({},this.state)),this.logger.debug(`Clustering ${e?"activado":"desactivado"}`)}toggleVirtualization(e){this.state.isVirtualizationActive=e,this.stateSubject.next(u({},this.state)),this.logger.debug(`Virtualizaci\xF3n ${e?"activada":"desactivada"}`)}updateState(e){this.state=u(u({},this.state),e),this.stateSubject.next(this.state)}measureExecutionTime(e){let t=performance.now(),r=e(),a=performance.now()-t;return{result:r,time:a}}updateElementCount(e,t){this.updateState({elementCount:e,visibleElements:t})}estimateMemoryUsage(){return W(5e3).pipe(X(()=>this.isMonitoring),p(()=>{let e=this.state.elementCount*5;return Math.round((e+50)/10)/100}),A(e=>{this.updateState({memoryUsage:e})}))}forceGarbageCollection(){window.gc?(this.logger.debug("Forzando recolecci\xF3n de basura"),window.gc()):this.logger.debug("La recolecci\xF3n de basura manual no est\xE1 disponible en este entorno")}getMetrics(){return this.state$.pipe(p(e=>({fps:e.fps,renderTime:e.renderTime,elementCount:e.elementCount,memoryUsage:e.memoryUsage,elapsed:performance.now()-this.monitoringStartTime})))}getMapStatistics(){return this.state$.pipe(p(e=>{let t="\xD3ptimo";e.fps<30&&e.fps>=20?t="Aceptable":e.fps<20&&e.fps>=10?t="Bajo":e.fps<10&&(t="Cr\xEDtico");let r=e.memoryUsage<1024?`${Math.round(e.memoryUsage)} MB`:`${(e.memoryUsage/1024).toFixed(2)} GB`;return{totalElements:e.elementCount,totalConnections:0,visibleConnections:0,totalAlerts:0,performanceLevel:t,memoryUsageFormatted:r,loadTime:0}}))}clearMemoizationCache(){this.logger.debug("Cach\xE9 de memoizaci\xF3n limpiada")}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=m({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();var He=(()=>{class i{constructor(){this.logger=S(f),this.mapService=S(I),this.mapStateService=S(te),this.isInteractionEnabledSubject=new c(!0),this.isInteractionEnabled$=this.isInteractionEnabledSubject.asObservable(),this.logger.debug("MapInteractionService inicializado")}disableInteraction(){this.isInteractionEnabledSubject.next(!1),this.logger.debug("Interacciones del mapa deshabilitadas");let e=this.mapService.getMap();e&&(e.dragging.disable(),e.touchZoom.disable(),e.doubleClickZoom.disable(),e.scrollWheelZoom.disable(),e.boxZoom.disable(),e.keyboard.disable())}enableInteraction(){this.isInteractionEnabledSubject.next(!0),this.logger.debug("Interacciones del mapa habilitadas");let e=this.mapService.getMap();e&&(e.dragging.enable(),e.touchZoom.enable(),e.doubleClickZoom.enable(),e.scrollWheelZoom.enable(),e.boxZoom.enable(),e.keyboard.enable())}enablePanning(){this.enableInteraction(),this.mapStateService.setActiveTool("pan"),this.logger.debug("Modo de navegaci\xF3n habilitado");let e=this.mapService.getMap();e&&e.dragging.enable()}enableSelection(){this.enableInteraction(),this.mapStateService.setActiveTool("select"),this.logger.debug("Modo de selecci\xF3n habilitado"),this.mapService.setTool("select")}enableMeasurement(){this.disableInteraction(),this.mapStateService.setActiveTool("measure"),this.logger.debug("Modo de medici\xF3n habilitado"),this.mapService.setTool("measure")}enableConnectionCreation(){this.disableInteraction(),this.mapStateService.setActiveTool("connect"),this.logger.debug("Modo de creaci\xF3n de conexiones habilitado"),this.mapService.setTool("connect")}enableAreaSelection(){this.disableInteraction(),this.mapStateService.setActiveTool("area"),this.logger.debug("Modo de selecci\xF3n por \xE1rea habilitado"),this.mapService.setTool("area")}enableElementEditing(){this.disableInteraction(),this.mapStateService.setActiveTool("edit"),this.logger.debug("Modo de edici\xF3n de elementos habilitado"),this.mapService.setTool("edit")}isToolActive(e){let t="pan";return this.mapStateService.activeTool$.subscribe(r=>t=r).unsubscribe(),t===e}getActiveTool(){return this.mapStateService.activeTool$}selectElement(e){e?e.id?(this.mapStateService.selectElements([e.id],!0),this.logger.debug(`Elemento seleccionado: ${e.id}`)):this.logger.warn("Intento de seleccionar un elemento sin ID",e):(this.mapStateService.setState({selectedElementIds:[]}),this.logger.debug("Elemento deseleccionado"))}selectConnection(e){e?this.logger.debug(`Conexi\xF3n seleccionada: ${e.id||"sin ID"}`):this.logger.debug("Conexi\xF3n deseleccionada")}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=m({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();var et=(()=>{class i{constructor(){this.logger=S(f),this.mapService=S(I),this.state={activeTool:"pan",isMeasuring:!1,measurements:[]},this.activeToolSubject=new c("pan"),this.isMeasuringSubject=new c(!1),this.measurementsSubject=new c([]),this.activeMeasurementSubject=new c(void 0),this.activeTool$=this.activeToolSubject.asObservable(),this.isMeasuring$=this.isMeasuringSubject.asObservable(),this.measurements$=this.measurementsSubject.asObservable(),this.activeMeasurement$=this.activeMeasurementSubject.asObservable(),this.logger.debug("MapToolsService inicializado")}getActiveTool(){return this.state.activeTool}setActiveTool(e){let t=this.state.activeTool;e!==t&&(this.state.previousTool=t,this.state.activeTool=e,t==="measure"&&this.state.isMeasuring&&this.cancelMeasurement(),this.configureMapForTool(e),this.logger.debug(`Herramienta cambiada: ${t} -> ${e}`),this.activeToolSubject.next(e))}configureMapForTool(e){switch(e){case"pan":this.mapService.disableInteraction(),this.mapService.enablePanning();break;case"select":this.mapService.disableInteraction(),this.mapService.enableSelection();break;case"measure":this.mapService.disableInteraction(),this.mapService.enableMeasurement();break;case"connect":this.mapService.disableInteraction(),this.mapService.enableConnectionCreation();break;case"area":case"polygon":this.mapService.disableInteraction(),this.mapService.enableAreaSelection();break;case"edit":this.mapService.disableInteraction(),this.mapService.enableElementEditing();break;default:this.logger.warn(`Herramienta no reconocida: ${e}`),this.mapService.disableInteraction(),this.mapService.enablePanning()}}restorePreviousTool(){this.state.previousTool?this.setActiveTool(this.state.previousTool):this.setActiveTool("pan")}startMeasurement(){this.state.activeTool!=="measure"&&this.setActiveTool("measure"),this.state.isMeasuring=!0,this.state.activeMeasurement={distance:0,coordinates:[],unit:"m"},this.isMeasuringSubject.next(!0),this.activeMeasurementSubject.next(this.state.activeMeasurement),this.logger.debug("Iniciando medici\xF3n")}updateMeasurement(e,t){!this.state.isMeasuring||!this.state.activeMeasurement||(this.state.activeMeasurement.coordinates.push([t,e]),this.state.activeMeasurement.coordinates.length>1&&(this.state.activeMeasurement.distance=this.calculateTotalDistance(this.state.activeMeasurement.coordinates),this.state.activeMeasurement.distance>1e3&&(this.state.activeMeasurement.unit="km",this.state.activeMeasurement.distance/=1e3)),this.activeMeasurementSubject.next(this.state.activeMeasurement),this.logger.debug(`Medici\xF3n actualizada: ${this.state.activeMeasurement.distance} ${this.state.activeMeasurement.unit}`))}finishMeasurement(){!this.state.isMeasuring||!this.state.activeMeasurement||(this.state.activeMeasurement.coordinates.length>1&&(this.state.measurements.push(u({},this.state.activeMeasurement)),this.measurementsSubject.next([...this.state.measurements]),this.logger.debug(`Medici\xF3n finalizada: ${this.state.activeMeasurement.distance} ${this.state.activeMeasurement.unit}`)),this.state.isMeasuring=!1,this.state.activeMeasurement=void 0,this.isMeasuringSubject.next(!1),this.activeMeasurementSubject.next(void 0))}cancelMeasurement(){this.state.isMeasuring&&(this.state.isMeasuring=!1,this.state.activeMeasurement=void 0,this.isMeasuringSubject.next(!1),this.activeMeasurementSubject.next(void 0),this.logger.debug("Medici\xF3n cancelada"))}clearMeasurements(){this.state.measurements=[],this.measurementsSubject.next([]),this.logger.debug("Mediciones eliminadas")}calculateTotalDistance(e){let t=0;for(let r=1;r<e.length;r++){let[a,s]=e[r-1],[n,l]=e[r];t+=this.calculateDistance(s,a,l,n)}return t}calculateDistance(e,t,r,a){let n=e*Math.PI/180,l=r*Math.PI/180,b=(r-e)*Math.PI/180,z=(a-t)*Math.PI/180,G=Math.sin(b/2)*Math.sin(b/2)+Math.cos(n)*Math.cos(l)*Math.sin(z/2)*Math.sin(z/2);return 6371e3*(2*Math.atan2(Math.sqrt(G),Math.sqrt(1-G)))}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=m({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();var ce=(()=>{class i{constructor(e,t,r){this.stateManager=e,this.logger=t,this.networkStateService=r,this.layerChangesSubject=new C,this.activeToolSubject=new c("pan"),this.activeLayersSubject=new c([]),this.mapReadySubject=new c(!1),this.darkModeSubject=new c(!1),this.destroy$=new C,this.stateManager.layerChanges.pipe(T(this.destroy$)).subscribe(()=>{this.layerChangesSubject.next()}),this.stateManager.activeTool$.pipe(T(this.destroy$)).subscribe(a=>{this.activeToolSubject.next(a)}),this.stateManager.activeLayers.pipe(T(this.destroy$)).subscribe(a=>{this.activeLayersSubject.next(a)}),this.stateManager.isDarkMode.pipe(T(this.destroy$)).subscribe(a=>{this.darkModeSubject.next(a)})}get layerChanges(){return this.layerChangesSubject.asObservable()}get activeTool$(){return this.activeToolSubject.asObservable()}get activeLayers$(){return this.activeLayersSubject.asObservable()}get mapReady$(){return this.mapReadySubject.asObservable()}get darkMode$(){return this.darkModeSubject.asObservable()}getAllLayers(){try{return this.stateManager.getAllLayers()}catch(e){return this.logger.error("Error al obtener capas en el adaptador",e),[]}}toggleLayerVisibility(e){try{this.stateManager.toggleLayerVisibility(e)}catch(t){this.logger.error(`Error al cambiar visibilidad de capa ${e} en el adaptador`,t)}}setActiveTool(e){try{this.stateManager.setActiveTool(e),this.activeToolSubject.next(e)}catch(t){this.logger.error(`Error al establecer herramienta ${e} en el adaptador`,t)}}setActiveLayers(e){}setDarkMode(e){try{this.stateManager.setDarkMode(e),this.darkModeSubject.next(e)}catch(t){this.logger.error("Error al establecer modo oscuro en el adaptador",t)}}destroy(){this.destroy$.next(),this.destroy$.complete(),this.layerChangesSubject.complete(),this.activeToolSubject.complete(),this.activeLayersSubject.complete(),this.mapReadySubject.complete(),this.darkModeSubject.complete()}static{this.\u0275fac=function(t){return new(t||i)(g(ee),g(f),g(Y))}}static{this.\u0275prov=m({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();var ut=(()=>{class i{constructor(e,t,r){this.logger=e,this.mapElementManagerAdapter=t,this.mapStateManagerAdapter=r,this.adaptersCache=new Map,this.featureFlags$=new c({useNewMapImplementation:!0,enableStandaloneMode:!0,useMapContainerInsteadOfNetworkMap:!0}),this.logger.info("StandaloneAdapterService inicializado")}getAdapter(e){if(this.adaptersCache.has(e))return this.adaptersCache.get(e);let t=this.createAdapter(e);return this.adaptersCache.set(e,t),t}createAdapter(e){switch(e){case"MapElementManagerService":return this.mapElementManagerAdapter;case"MapStateManagerService":return this.mapStateManagerAdapter;default:return this.logger.warn(`No se encontr\xF3 adaptador para ${e}, devolviendo proxy gen\xE9rico`),this.createGenericAdapter()}}createGenericAdapter(){return new Proxy({},{get:(e,t)=>{if(typeof t=="string")return(...r)=>(this.logger.debug(`Llamada a m\xE9todo no implementado: ${String(t)}`,r),K)}})}setFeatureFlag(e,t){let r=this.featureFlags$.value;this.featureFlags$.next(w(u({},r),{[e]:t}))}getFeatureFlag(e){return this.featureFlags$.value[e]||!1}get featureFlags(){return this.featureFlags$.asObservable()}getFeatureFlagStream(e){return this.featureFlags.pipe(p(t=>t[e]||!1))}static{this.\u0275fac=function(t){return new(t||i)(g(f),g(re),g(ce))}}static{this.\u0275prov=m({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();export{ie as a,Ie as b,et as c,Ue as d,ut as e,He as f};
