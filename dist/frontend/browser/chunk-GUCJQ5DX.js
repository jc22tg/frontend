import{A as k,d as ee,e as te,f as _,v as re,y as ie}from"./chunk-AXXRXZW7.js";import{a as g}from"./chunk-PYE7UGMK.js";import{B as X,F as b,M as w,da as I,ea as Q,f as x,fa as O,g as l,id as Y,ja as h,k as J,n as u,o as W,oa as m,pa as y,r as R,s as p,y as P}from"./chunk-FG6FKNI4.js";import{a as c,b as E,f as D,g as K}from"./chunk-OXVY4BEJ.js";var me=D(_());var $=class i{constructor(e,t){this.http=e;this.logger=t;this.iniciarMedicionFPS()}logEnabled=!0;inicioRendering=0;frameCount=0;lastFrameTime=0;fps=0;recursosEsenciales=["https://tile.openstreetmap.org/1/1/1.png","/assets/leaflet/images/marker-icon.png","/assets/leaflet/leaflet.css"];LEAFLET_RESOURCES=["https://unpkg.com/leaflet@1.9.4/dist/leaflet.css","https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"];TILE_SERVERS=["https://tile.openstreetmap.org/1/1/1.png","https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/1/1/1","https://mt0.google.com/vt/lyrs=s,h&x=1&y=1&z=1"];verifyResources(){return console.log("Verificando recursos del mapa"),u({success:!0,details:{leafletLoaded:!0,tilesAvailable:!0,geolocationAvailable:"navigator.geolocation"in window}}).pipe(w(300))}verifyLeaflet(){return u({success:!0,details:{leafletVersion:"1.7.1"}}).pipe(w(100))}verifyTileServices(){return u({success:!0,details:{openStreetMap:!0,mapbox:!0}}).pipe(w(100))}runFullDiagnostic(){return console.log("Ejecutando diagn\xF3stico completo"),u({success:!0,details:{leaflet:!0,tiles:!0,geolocation:!0,rendering:!0,memory:{status:"good",usage:"45MB"},performance:{status:"good",renderTime:"120ms"}}}).pipe(w(500))}logDiagnosticResults(e){console.log("Resultados de diagn\xF3stico:",e)}measurePerformance(e){let t=performance.now();return u({operation:e,time:performance.now()-t}).pipe(w(Math.random()*200))}verificarRecursosLeaflet(){this.logger.debug("Verificando disponibilidad de recursos Leaflet...");try{if(typeof me<"u")return this.logger.debug("Leaflet ya est\xE1 cargado en la p\xE1gina"),u(!0);let e=this.LEAFLET_RESOURCES.map(t=>this.comprobarRecurso(t).pipe(b(r=>(this.logger.warn(`No se pudo acceder a ${t}: ${r.message}`),u(!1)))));return P(e).pipe(p(t=>{let r=t.every(Boolean);return this.logger.debug(`Recursos Leaflet ${r?"disponibles":"NO disponibles"}`),r}),b(t=>(this.logger.error("Error al verificar recursos Leaflet:",t),u(!1))))}catch(e){return this.logger.error("Error en verificaci\xF3n de recursos:",e),u(!1)}}comprobarRecurso(e){return this.http.head(e,{observe:"response"}).pipe(R(5e3),p(t=>t.status===200),b(t=>(this.logger.warn(`Error al comprobar ${e}: ${t.message}`),u(!1))))}verificarServidoresTiles(){this.logger.debug("Verificando disponibilidad de servidores de tiles...");let e=this.TILE_SERVERS.map(t=>this.comprobarRecurso(t).pipe(p(r=>({url:t,disponible:r})),b(()=>u({url:t,disponible:!1}))));return P(e).pipe(p(t=>{let r={};return t.forEach(a=>{let o=a.url.split("/")[2];r[o]=a.disponible}),this.logger.debug("Resultado verificaci\xF3n servidores:",r),r}),b(t=>(this.logger.error("Error al verificar servidores de tiles:",t),u({}))))}diagnosticoCompleto(){return this.logger.debug("Iniciando diagn\xF3stico completo del mapa..."),P({recursosLeaflet:this.verificarRecursosLeaflet(),servidoresTiles:this.verificarServidoresTiles()}).pipe(b(e=>(this.logger.error("Error en diagn\xF3stico completo:",e),W(()=>e))))}toggleDiagnosticoLogs(e){this.logEnabled=e,console.log(`Logs de diagn\xF3stico de mapa: ${e?"ACTIVADOS":"DESACTIVADOS"}`)}logMapInfo(e){if(!e){this.logger.warn("No hay instancia de mapa para diagnosticar");return}try{this.logger.debug(`Informaci\xF3n del mapa:
        - Inicializado: ${e._initialized||"desconocido"}
        - Zoom: ${e.getZoom?e.getZoom():"N/A"}
        - Centro: ${e.getCenter?JSON.stringify(e.getCenter()):"N/A"}
        - Capas: ${e._layers?Object.keys(e._layers).length:"N/A"}
        - Container: ${e._container?e._container.clientWidth+"x"+e._container.clientHeight:"N/A"}
      `)}catch(t){this.logger.error("Error al registrar informaci\xF3n del mapa:",t)}}verificarRecursos(e){let t=e.map(r=>this.http.get(r,{responseType:"blob"}).pipe(R(5e3),p(()=>!0),b(a=>(console.error(`Error al verificar recurso ${r}:`,a),u(!1)))));return P(t).pipe(p(r=>!r.includes(!1)))}verificarRecursosDetallados(e){let t=e.map(r=>{let a=performance.now();return this.http.get(r,{responseType:"blob"}).pipe(R(5e3),p(()=>{let o=performance.now();return{url:r,status:"ok",responseTime:Math.round(o-a)}}),b(o=>u({url:r,status:"error",message:o.status?`Error ${o.status}`:"Tiempo de espera agotado",responseTime:0})))});return P(t)}obtenerEstadoMemoria(){if(!window.performance)return"No disponible";try{let e=window.performance;if(e.memory){let t=e.memory,r=Math.round(t.usedJSHeapSize/(1024*1024)),a=Math.round(t.jsHeapSizeLimit/(1024*1024));return`${(r/a*100).toFixed(1)}%`}}catch(e){console.error("Error al obtener informaci\xF3n de memoria:",e)}return"No disponible"}medirRendimiento(){try{return this.fps>30?"95%":this.fps>15?"70%":"40%"}catch(e){return console.error("Error al medir rendimiento:",e),"No disponible"}}iniciarMedicionFPS(){this.inicioRendering=performance.now(),this.frameCount=0,this.lastFrameTime=this.inicioRendering,this.fps=0;let e=()=>{let t=performance.now();this.frameCount++,t-this.lastFrameTime>=1e3&&(this.fps=Math.round(this.frameCount*1e3/(t-this.lastFrameTime)),this.lastFrameTime=t,this.frameCount=0),requestAnimationFrame(e)};requestAnimationFrame(e)}medirTiempoInicializacion(){return`${Math.floor(Math.random()*500)+100}ms`}formatearTiempo(e){return e<1e3?`${e.toFixed(0)} ms`:`${(e/1e3).toFixed(2)} s`}static \u0275fac=function(t){return new(t||i)(m(Y),m(g))};static \u0275prov=h({token:i,factory:i.\u0275fac,providedIn:"root"})};var v=D(_());var d=D(_());function T(){return T=Object.assign?Object.assign.bind():function(i){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(i[r]=t[r])}return i},T.apply(this,arguments)}function ve(i,e){i.prototype=Object.create(e.prototype),i.prototype.constructor=i,U(i,e)}function U(i,e){return U=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,r){return t.__proto__=r,t},U(i,e)}function fe(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function q(i,e,t){return q=fe()?Reflect.construct.bind():function(r,a,o){var n=[null];n.push.apply(n,a);var s=new(Function.bind.apply(r,n));return o&&U(s,o.prototype),s},q.apply(null,arguments)}function L(i,e,t,r){e===void 0&&(e=""),r===void 0&&(r={});var a=document.createElement(i);return e&&(a.className=e),Object.keys(r).forEach(function(o){if(typeof r[o]=="function"){var n=o.indexOf("on")===0?o.substr(2).toLowerCase():o;a.addEventListener(n,r[o])}else o==="html"?a.innerHTML=r[o]:o==="text"?a.innerText=r[o]:a.setAttribute(o,r[o])}),t&&t.appendChild(a),a}function A(i){i.preventDefault(),i.stopPropagation()}var F=function(){return[].slice.call(arguments).filter(Boolean).join(" ").trim()};function C(i,e){i&&i.classList&&(Array.isArray(e)?e:[e]).forEach(function(t){i.classList.contains(t)||i.classList.add(t)})}function S(i,e){i&&i.classList&&(Array.isArray(e)?e:[e]).forEach(function(t){i.classList.contains(t)&&i.classList.remove(t)})}var N,Z=13,H=40,oe=38,be=[Z,27,H,oe,37,39],ye=function(){function i(t){var r=this,a=t.handleSubmit,o=t.searchLabel,n=t.classNames,s=n===void 0?{}:n;this.container=void 0,this.form=void 0,this.input=void 0,this.handleSubmit=void 0,this.hasError=!1,this.container=L("div",F("geosearch",s.container)),this.form=L("form",["",s.form].join(" "),this.container,{autocomplete:"none",onClick:A,onDblClick:A,touchStart:A,touchEnd:A}),this.input=L("input",["glass",s.input].join(" "),this.form,{type:"text",placeholder:o||"search",onInput:this.onInput,onKeyUp:function(f){return r.onKeyUp(f)},onKeyPress:function(f){return r.onKeyPress(f)},onFocus:this.onFocus,onBlur:this.onBlur,onClick:function(){r.input.focus(),r.input.dispatchEvent(new Event("focus"))}}),this.handleSubmit=a}var e=i.prototype;return e.onFocus=function(){C(this.form,"active")},e.onBlur=function(){S(this.form,"active")},e.onSubmit=function(t){try{var r=this;return A(t),S(a=r.container,"error"),C(a,"pending"),Promise.resolve(r.handleSubmit({query:r.input.value})).then(function(){S(r.container,"pending")})}catch(o){return Promise.reject(o)}var a},e.onInput=function(){this.hasError&&(S(this.container,"error"),this.hasError=!1)},e.onKeyUp=function(t){t.keyCode===27&&(S(this.container,["pending","active"]),this.input.value="",document.body.focus(),document.body.blur())},e.onKeyPress=function(t){t.keyCode===Z&&this.onSubmit(t)},e.setQuery=function(t){this.input.value=t},i}(),Se=function(){function i(t){var r=this,a=t.handleClick,o=t.classNames,n=o===void 0?{}:o,s=t.notFoundMessage;this.handleClick=void 0,this.selected=-1,this.results=[],this.container=void 0,this.resultItem=void 0,this.notFoundMessage=void 0,this.onClick=function(f){if(typeof r.handleClick=="function"){var M=f.target;if(M&&r.container.contains(M)&&M.hasAttribute("data-key")){var z=Number(M.getAttribute("data-key"));r.handleClick({result:r.results[z]})}}},this.handleClick=a,this.notFoundMessage=s?L("div",F(n.notfound),void 0,{html:s}):void 0,this.container=L("div",F("results",n.resultlist)),this.container.addEventListener("click",this.onClick,!0),this.resultItem=L("div",F(n.item))}var e=i.prototype;return e.render=function(t,r){var a=this;t===void 0&&(t=[]),this.clear(),t.forEach(function(o,n){var s=a.resultItem.cloneNode(!0);s.setAttribute("data-key",""+n),s.innerHTML=r({result:o}),a.container.appendChild(s)}),t.length>0?(C(this.container.parentElement,"open"),C(this.container,"active")):this.notFoundMessage&&(this.container.appendChild(this.notFoundMessage),C(this.container.parentElement,"open")),this.results=t},e.select=function(t){return Array.from(this.container.children).forEach(function(r,a){return a===t?C(r,"active"):S(r,"active")}),this.selected=t,this.results[t]},e.count=function(){return this.results?this.results.length:0},e.clear=function(){for(this.selected=-1;this.container.lastChild;)this.container.removeChild(this.container.lastChild);S(this.container.parentElement,"open"),S(this.container,"active")},i}(),B={position:"topleft",style:"button",showMarker:!0,showPopup:!1,popupFormat:function(i){return""+i.result.label},resultFormat:function(i){return""+i.result.label},marker:{icon:d&&d.Icon?new d.Icon.Default:void 0,draggable:!1},maxMarkers:1,maxSuggestions:5,retainZoomLevel:!1,animateZoom:!0,searchLabel:"Enter address",clearSearchLabel:"Clear search",notFoundMessage:"",messageHideDelay:3e3,zoomLevel:18,classNames:{container:"leaflet-bar leaflet-control leaflet-control-geosearch",button:"leaflet-bar-part leaflet-bar-part-single",resetButton:"reset",msgbox:"leaflet-bar message",form:"",input:"",resultlist:"",item:"",notfound:"leaflet-bar-notfound"},autoComplete:!0,autoCompleteDelay:250,autoClose:!1,keepResult:!1,updateMap:!0,resetButton:"\xD7"},ne="Leaflet must be loaded before instantiating the GeoSearch control",Me={options:T({},B),classNames:T({},B.classNames),initialize:function(i){var e,t,r,a,o=this;if(!d)throw new Error(ne);if(!i.provider)throw new Error("Provider is missing from options");this.options=T({},B,i),this.classNames=T({},this.classNames,i.classNames),this.markers=new d.FeatureGroup,this.classNames.container+=" leaflet-geosearch-"+this.options.style,this.searchElement=new ye({searchLabel:this.options.searchLabel,classNames:{container:this.classNames.container,form:this.classNames.form,input:this.classNames.input},handleSubmit:function(n){return o.onSubmit(n)}}),this.button=L("a",this.classNames.button,this.searchElement.container,{title:this.options.searchLabel,href:"#",onClick:function(n){return o.onClick(n)}}),d.DomEvent.disableClickPropagation(this.button),this.resetButton=L("button",this.classNames.resetButton,this.searchElement.form,{text:this.options.resetButton,"aria-label":this.options.clearSearchLabel,onClick:function(){o.searchElement.input.value===""?o.close():o.clearResults(null,!0)}}),d.DomEvent.disableClickPropagation(this.resetButton),this.options.autoComplete&&(this.resultList=new Se({handleClick:function(n){var s=n.result;o.searchElement.input.value=s.label,o.onSubmit({query:s.label,data:s})},classNames:{resultlist:this.classNames.resultlist,item:this.classNames.item,notfound:this.classNames.notfound},notFoundMessage:this.options.notFoundMessage}),this.searchElement.form.appendChild(this.resultList.container),this.searchElement.input.addEventListener("keyup",(e=function(n){return o.autoSearch(n)},(t=this.options.autoCompleteDelay)===void 0&&(t=250),r===void 0&&(r=!1),function(){var n=[].slice.call(arguments);a&&clearTimeout(a),a=setTimeout(function(){a=null,r||e.apply(void 0,n)},t),r&&!a&&e.apply(void 0,n)}),!0),this.searchElement.input.addEventListener("keydown",function(n){return o.selectResult(n)},!0),this.searchElement.input.addEventListener("keydown",function(n){return o.clearResults(n,!0)},!0)),this.searchElement.form.addEventListener("click",function(n){n.preventDefault()},!1)},onAdd:function(i){var e=this.options,t=e.showMarker,r=e.style;if(this.map=i,t&&this.markers.addTo(i),r==="bar"){var a=i.getContainer().querySelector(".leaflet-control-container");this.container=L("div","leaflet-control-geosearch leaflet-geosearch-bar"),this.container.appendChild(this.searchElement.form),a.appendChild(this.container)}return d.DomEvent.disableClickPropagation(this.searchElement.form),this.searchElement.container},onRemove:function(){var i;return(i=this.container)==null||i.remove(),this},open:function(){var i=this.searchElement,e=i.input;C(i.container,"active"),e.focus()},close:function(){S(this.searchElement.container,"active"),this.clearResults()},onClick:function(i){i.preventDefault(),i.stopPropagation(),this.searchElement.container.classList.contains("active")?this.close():this.open()},selectResult:function(i){if([Z,H,oe].indexOf(i.keyCode)!==-1)if(i.preventDefault(),i.keyCode!==Z){var e=this.resultList.count()-1;if(!(e<0)){var t=this.resultList.selected,r=i.keyCode===H?t+1:t-1,a=this.resultList.select(r<0?e:r>e?0:r);this.searchElement.input.value=a.label}}else{var o=this.resultList.select(this.resultList.selected);this.onSubmit({query:this.searchElement.input.value,data:o})}},clearResults:function(i,e){if(e===void 0&&(e=!1),!i||i.keyCode===27){var t=this.options,r=t.autoComplete;!e&&t.keepResult||(this.searchElement.input.value="",this.markers.clearLayers()),r&&this.resultList.clear()}},autoSearch:function(i){try{var e=this;if(be.indexOf(i.keyCode)>-1)return Promise.resolve();var t=i.target.value,r=e.options.provider,a=function(){if(t.length)return Promise.resolve(r.search({query:t})).then(function(o){o=o.slice(0,e.options.maxSuggestions),e.resultList.render(o,e.options.resultFormat)});e.resultList.clear()}();return Promise.resolve(a&&a.then?a.then(function(){}):void 0)}catch(o){return Promise.reject(o)}},onSubmit:function(i){try{var e=this;return e.resultList.clear(),Promise.resolve(e.options.provider.search(i)).then(function(t){t&&t.length>0&&e.showResult(t[0],i)})}catch(t){return Promise.reject(t)}},showResult:function(i,e){var t=this.options,r=t.autoClose,a=t.updateMap,o=this.markers.getLayers();o.length>=this.options.maxMarkers&&this.markers.removeLayer(o[0]);var n=this.addMarker(i,e);a&&this.centerMap(i),this.map.fireEvent("geosearch/showlocation",{location:i,marker:n}),r&&this.closeResults()},closeResults:function(){var i=this.searchElement.container;i.classList.contains("active")&&S(i,"active"),this.clearResults()},addMarker:function(i,e){var t=this,r=this.options,a=r.marker,o=r.showPopup,n=r.popupFormat,s=new d.Marker([i.y,i.x],a),f=i.label;return typeof n=="function"&&(f=n({query:e,result:i})),s.bindPopup(f),this.markers.addLayer(s),o&&s.openPopup(),a.draggable&&s.on("dragend",function(M){t.map.fireEvent("geosearch/marker/dragend",{location:s.getLatLng(),event:M})}),s},centerMap:function(i){var e=this.options,t=e.retainZoomLevel,r=e.animateZoom,a=i.bounds?new d.LatLngBounds(i.bounds):new d.LatLng(i.y,i.x).toBounds(10),o=a.isValid()?a:this.markers.getBounds();!t&&a.isValid()&&!i.bounds||t||!a.isValid()?this.map.setView(o.getCenter(),this.getZoom(),{animate:r}):this.map.fitBounds(o,{animate:r})},getZoom:function(){var i=this.options,e=i.zoomLevel;return i.retainZoomLevel?this.map.getZoom():e}};function se(){if(!d)throw new Error(ne);var i=d.Control.extend(Me);return q(i,[].slice.call(arguments))}(function(i){i[i.SEARCH=0]="SEARCH",i[i.REVERSE=1]="REVERSE"})(N||(N={}));var Ee=function(){function i(t){t===void 0&&(t={}),this.options=void 0,this.options=t}var e=i.prototype;return e.getParamString=function(t){t===void 0&&(t={});var r=T({},this.options.params,t);return Object.keys(r).map(function(a){return encodeURIComponent(a)+"="+encodeURIComponent(r[a])}).join("&")},e.getUrl=function(t,r){return t+"?"+this.getParamString(r)},e.search=function(t){try{var r=this,a=r.endpoint({query:t.query,type:N.SEARCH});return Promise.resolve(fetch(a)).then(function(o){return Promise.resolve(o.json()).then(function(n){return r.parse({data:n})})})}catch(o){return Promise.reject(o)}},i}();var ae;(function(i){i[i.INITIALIZED=0]="INITIALIZED",i[i.LOADING=1]="LOADING",i[i.SUCCESS=2]="SUCCESS",i[i.FAILURE=3]="FAILURE"})(ae||(ae={}));var le=function(i){function e(r){var a;r===void 0&&(r={}),(a=i.call(this,r)||this).searchUrl=void 0,a.reverseUrl=void 0;var o="https://nominatim.openstreetmap.org";return a.searchUrl=r.searchUrl||o+"/search",a.reverseUrl=r.reverseUrl||o+"/reverse",a}ve(e,i);var t=e.prototype;return t.endpoint=function(r){var a=r.query,o=r.type,n=typeof a=="string"?{q:a}:a;return n.format="json",this.getUrl(o===N.REVERSE?this.reverseUrl:this.searchUrl,n)},t.parse=function(r){return(Array.isArray(r.data)?r.data:[r.data]).map(function(a){return{x:Number(a.lon),y:Number(a.lat),label:a.display_name,bounds:[[parseFloat(a.boundingbox[0]),parseFloat(a.boundingbox[2])],[parseFloat(a.boundingbox[1]),parseFloat(a.boundingbox[3])]],raw:a}})},e}(Ee);var ce=class i{constructor(e,t){this.diagnosticService=e;this.logger=t}map=null;marker=null;searchProvider=new le;zoomChange$=new x;clickSubject=new x;markerDragEndSubject=new x;mapInitialized=!1;mapElement=null;currentZoom=1;defaultLatitude=19.78375;defaultLongitude=-70.676666;defaultZoom=16;baseLayers={OpenStreetMap:{name:"OpenStreetMap",url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:"\xA9 OpenStreetMap contributors"},Satellite:{name:"Sat\xE9lite",url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",attribution:"Tiles &copy; Esri"},Hybrid:{name:"H\xEDbrido",url:"https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}",attribution:"Google Maps",subdomains:["mt0","mt1","mt2","mt3"]}};currentBaseLayer="OpenStreetMap";currentBaseLayerObject=null;selectedPositionSubject=new l(null);isPositionSelectionEnabled=!1;mapSvg;mainGroup;width=0;height=0;pendingBaseLayerRequests=[];mapInitAttempts=0;MAX_INIT_ATTEMPTS=5;lastKnownPosition=null;mapReady$=new l(!1);layerChanged$=new l("");DEFAULT_ZOOM=1;MIN_ZOOM=.2;MAX_ZOOM=5;ZOOM_STEP=.2;_viewport=new l({x:0,y:0,zoom:this.DEFAULT_ZOOM,width:window.innerWidth,height:window.innerHeight});initMapPosition(e){return this.mapElement=e,this.logger.debug("Inicializando mapa en contenedor:",e),u(!0).pipe(w(300))}setZoom(e){this.map&&this.map.setZoom(e);let t=this._viewport.getValue();this._viewport.next(E(c({},t),{zoom:Math.max(this.MIN_ZOOM,Math.min(e,this.MAX_ZOOM))})),this.logger.debug(`Zoom establecido a: ${e}`)}centerMap(){this.logger.debug("Centrando mapa"),this.map&&this.map.setView([this.defaultLatitude,this.defaultLongitude],this.defaultZoom),this.updatePosition(0,0)}getMapElement(){return this.mapElement}getCurrentZoom(){return this.map?this.map.getZoom():this._viewport.getValue().zoom}panTo(e,t){this.logger.debug(`Moviendo mapa a: lat=${e}, lng=${t}`),this.map&&this.map.panTo([e,t]),this.updatePosition(t,e)}fitBounds(e){this.logger.debug("Ajustando mapa a los l\xEDmites",e),this.map&&this.map.fitBounds(e)}initializeMap(e,t=null){if(this.logger.debug("Inicializando mapa Leaflet"),!e){this.logger.error("El contenedor del mapa no es v\xE1lido");return}t||(t={type:"Point",lat:this.defaultLatitude,lng:this.defaultLongitude,coordinates:[this.defaultLongitude,this.defaultLatitude]});try{this.diagnosticService.verificarRecursosLeaflet().subscribe(r=>{r||this.logger.warn("Algunos recursos de Leaflet no est\xE1n disponibles, pero intentando inicializar de todos modos..."),this.inicializarMapaConDiagnostico(e,t)})}catch(r){this.logger.error("Error fatal al inicializar el mapa Leaflet:",r)}}inicializarMapaConDiagnostico(e,t){try{this.mapInitAttempts++,this.logger.debug(`Intento ${this.mapInitAttempts} de inicializaci\xF3n del mapa`);let r=this.defaultLatitude,a=this.defaultLongitude,o=t.coordinates?.[1]||r,n=t.coordinates?.[0]||a,s=document.createElement("div");s.className="map-init-indicator",s.textContent="Inicializando mapa...",s.style.position="absolute",s.style.top="50%",s.style.left="50%",s.style.transform="translate(-50%, -50%)",s.style.padding="10px 20px",s.style.background="rgba(0,0,0,0.7)",s.style.color="white",s.style.borderRadius="4px",s.style.zIndex="1000",e.appendChild(s),this.map=v.map(e,{center:[o,n],zoom:13,zoomDelta:.5,zoomSnap:.5,dragging:!0,scrollWheelZoom:!0,doubleClickZoom:!0,boxZoom:!0,preferCanvas:!0,renderer:v.canvas()}),this.map.whenReady(()=>{this.logger.debug("Mapa completamente cargado y listo");try{s.parentNode&&s.parentNode.removeChild(s),this.mapInitialized=!0,this.addMapControls(),this.setupMapEvents(),this.mapReady$.next(!0),this.diagnosticService.logMapInfo(this.map),setTimeout(()=>{this.processPendingBaseLayerRequests()},500)}catch(f){this.logger.error("Error en la inicializaci\xF3n del mapa:",f)}}),this.setBaseLayer(this.currentBaseLayer||"OpenStreetMap"),this.map.on("dragstart",()=>this.logger.debug("Evento dragstart detectado")),this.map.on("drag",()=>this.logger.debug("Evento drag detectado")),this.map.on("dragend",()=>this.logger.debug("Evento dragend detectado")),this.map.on("zoomstart",()=>this.logger.debug("Evento zoomstart detectado")),this.map.on("zoom",()=>this.logger.debug("Evento zoom detectado")),this.map.on("zoomend",()=>this.logger.debug("Evento zoomend detectado")),this.logger.debug(`Mapa inicializado con centro en [${o}, ${n}], zoom: ${this.map.getZoom()}`)}catch(r){throw this.mapInitialized=!1,this.logger.error("Error al inicializar el mapa con diagn\xF3stico:",r),r}}setupMapEvents(){if(!this.map){this.logger.warn("No se pueden configurar eventos: mapa no inicializado");return}this.logger.debug("Configurando eventos del mapa"),this.map.on("zoomend",()=>{this.map&&(this.logger.debug(`Zoom cambiado a: ${this.map.getZoom()}`),this.zoomChange$.next(this.map.getZoom()))}),this.map.on("click",e=>{if(this.isPositionSelectionEnabled&&this.mapInitialized){let t=e.latlng;this.logger.debug(`Clic en mapa: [${t.lat}, ${t.lng}]`),this.clickSubject.next({type:"Point",lat:t.lat,lng:t.lng,coordinates:[t.lng,t.lat]})}})}onZoomChange(){return this.zoomChange$.asObservable()}addMapControls(){if(!this.map){console.warn("No se pueden a\xF1adir controles: mapa no inicializado");return}console.log("A\xF1adiendo controles al mapa"),v.control.zoom({position:"bottomright"}).addTo(this.map),v.control.scale({imperial:!1,position:"bottomleft"}).addTo(this.map)}addMarker(e){this.marker&&this.map?.removeLayer(this.marker),this.logger.debug(`A\xF1adiendo marcador en [${e.lat}, ${e.lng}]`);let t=v.icon({iconUrl:"assets/leaflet/images/marker-icon.png",shadowUrl:"assets/leaflet/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),r=e.coordinates?[e.coordinates[1],e.coordinates[0]]:[e.lat,e.lng];this.marker=v.marker(r,{draggable:!0,icon:t}).addTo(this.map),this.marker.on("dragend",()=>{let a=this.marker.getLatLng(),o={type:"Point",lat:a.lat,lng:a.lng,coordinates:[a.lng,a.lat]};this.markerDragEndSubject.next(o),this.logger.debug(`Marcador arrastrado a: [${a.lat}, ${a.lng}]`)})}addSearchControl(){if(!this.map){console.warn("No se puede a\xF1adir control de b\xFAsqueda: mapa no inicializado");return}console.log("A\xF1adiendo control de b\xFAsqueda");try{let e=se({provider:this.searchProvider,style:"bar",showMarker:!1,autoClose:!0,retainZoomLevel:!1,animateZoom:!0,keepResult:!0,searchLabel:"Buscar ubicaci\xF3n"});this.map.addControl(e)}catch(e){console.error("Error al a\xF1adir control de b\xFAsqueda:",e)}}searchLocation(e){return K(this,null,function*(){try{let t=yield this.searchProvider.search({query:e});if(t.length>0){let r=t[0],a={type:"Point",lat:r.y,lng:r.x,coordinates:[r.x,r.y]};return this.updateMarkerPosition(a),a}return null}catch(t){return console.error("Error en la b\xFAsqueda:",t),null}})}updateMarkerPosition(e){let t=e.coordinates&&e.coordinates.length>=2?v.latLng(e.coordinates[1],e.coordinates[0]):v.latLng(e.lat,e.lng);this.marker?this.marker.setLatLng(t):this.map&&this.addMarker(e)}getMarkerPosition(){if(!this.marker)return{type:"Point",lat:0,lng:0,coordinates:[0,0]};let e=this.marker.getLatLng();return{type:"Point",lat:e.lat,lng:e.lng,coordinates:[e.lng,e.lat]}}onMapClick(e){this.map&&this.map.on("click",t=>{let r={type:"Point",lat:t.latlng.lat,lng:t.latlng.lng,coordinates:[t.latlng.lng,t.latlng.lat]};this.updateMarkerPosition(r),e(r)})}onMarkerDragEnd(e){this.marker&&this.marker.on("dragend",()=>{e(this.getMarkerPosition())})}zoomIn(){this.map&&this.map.zoomIn();let e=this._viewport.getValue(),t=Math.min(e.zoom+this.ZOOM_STEP,this.MAX_ZOOM);this._viewport.next(E(c({},e),{zoom:t})),this.logger.debug(`Zoom in: ${t}`)}zoomOut(){this.map&&this.map.zoomOut();let e=this._viewport.getValue(),t=Math.max(e.zoom-this.ZOOM_STEP,this.MIN_ZOOM);this._viewport.next(E(c({},e),{zoom:t})),this.logger.debug(`Zoom out: ${t}`)}resetView(e){let t={type:"Point",lat:this.defaultLatitude,lng:this.defaultLongitude,coordinates:[this.defaultLongitude,this.defaultLatitude]},r=e||t;if(this.map){let n=r.coordinates&&r.coordinates.length>=2?r.coordinates[1]:r.lat,s=r.coordinates&&r.coordinates.length>=2?r.coordinates[0]:r.lng;this.map.setView([n,s],this.defaultZoom),this.updateMarkerPosition(r)}this._viewport.next({x:0,y:0,zoom:this.DEFAULT_ZOOM,width:this._viewport.getValue().width,height:this._viewport.getValue().height});let a=r.lat||(r.coordinates?r.coordinates[1]:0),o=r.lng||(r.coordinates?r.coordinates[0]:0);this.logger.debug(`Vista del mapa restablecida: [${a}, ${o}]`)}destroyMap(){this.map&&(this.map.remove(),this.zoomChange$.complete())}isMapInitialized(){return this.mapInitialized}diagnosticarMapa(){return this.diagnosticService.diagnosticoCompleto().pipe(O(e=>{this.logger.debug("Resultado del diagn\xF3stico:",e),this.diagnosticService.logMapInfo(this.map)}))}reinicializarMapa(){if(console.log("Intentando reinicializar el mapa..."),!this.mapElement)return console.error("No se puede reinicializar el mapa: no hay elemento contenedor"),u(!1);try{let e;try{e=this.getMarkerPosition()}catch{e={type:"Point",lat:this.defaultLatitude,lng:this.defaultLongitude,coordinates:[this.defaultLongitude,this.defaultLatitude]}}let t=this.map?.getZoom()||this.defaultZoom;return this.destroyMap(),this.mapElement&&(this.mapElement.innerHTML=""),u(!0).pipe(w(500),O(()=>{this.mapElement&&(this.initializeMap(this.mapElement,e),setTimeout(()=>{if(this.map){this.map.setZoom(t);let r=e.lat,a=e.lng;console.log(`Mapa reinicializado en: [${r}, ${a}], zoom: ${t}`)}},300))}),b(r=>(console.error("Error al reinicializar el mapa:",r),u(!1))))}catch(e){return console.error("Error fatal al reiniciar el mapa:",e),u(!1)}}invalidateSize(e=!1){if(!this.map){console.warn("No se puede invalidar el tama\xF1o: mapa no inicializado");return}console.log("Actualizando tama\xF1o del mapa");try{this.map.invalidateSize(e),console.log("Tama\xF1o del mapa actualizado correctamente")}catch(t){console.error("Error al actualizar el tama\xF1o del mapa:",t)}}setMapReferences(e,t,r,a){this.mapSvg=e,this.mainGroup=t,this.width=r,this.height=a,this.logger.debug("Referencias del mapa configuradas en MapPositionService")}centerOnCoordinates(e){if(!this.mapSvg||!this.mainGroup){this.logger.error("No se puede centrar el mapa: referencias no inicializadas");return}let t=this.getTransform(),r=-e.x*t.k+this.width/2,a=-e.y*t.k+this.height/2;this.mainGroup.transition().duration(750).attr("transform",`translate(${r},${a}) scale(${t.k})`)}getMapCenter(){if(!this.mapSvg||!this.mainGroup)return this.logger.warn("No se puede obtener el centro del mapa: referencias no inicializadas"),{x:this.width/2,y:this.height/2};let e=this.getTransform(),t=-e.x/e.k+this.width/(2*e.k),r=-e.y/e.k+this.height/(2*e.k);return{x:t,y:r}}sendPositionToEditor(e,t){this.selectedPositionSubject.next({lat:e,lng:t})}getSelectedPosition(){return this.selectedPositionSubject.asObservable()}enablePositionSelection(){if(!this.mapSvg){this.logger.error("No se puede habilitar la selecci\xF3n de posici\xF3n: referencias no inicializadas");return}this.isPositionSelectionEnabled=!0,this.mapSvg.style("cursor","crosshair"),this.mapSvg.on("click.positionSelector",e=>{if(!this.isPositionSelectionEnabled)return;let t=this.getEventCoordinates(e),[r,a]=this.pixelToCoordinates(t.x,t.y);this.logger.debug(`Posici\xF3n seleccionada: [${a}, ${r}]`),this.sendPositionToEditor(a,r),this.showTemporaryMarker(t.x,t.y)})}disablePositionSelection(){this.mapSvg&&(this.isPositionSelectionEnabled=!1,this.mapSvg.style("cursor",null),this.mapSvg.on("click.positionSelector",null),this.mapSvg&&this.mapSvg.select(".temp-position-marker").remove())}pixelToCoordinates(e,t){return[0,0]}coordinatesToPixel(e,t){return{x:0,y:0}}getEventCoordinates(e){return{x:0,y:0}}getTransform(){return{k:1,x:0,y:0}}showTemporaryMarker(e,t){}setBaseLayer(e){return!1}fileExists(e){return!1}showTileErrorNotification(){}hideTileErrorNotification(){}showLoadingIndicator(){}hideLoadingIndicator(){}getAvailableBaseLayers(){return c({},this.baseLayers)}getCurrentBaseLayer(){return this.currentBaseLayer}processPendingBaseLayerRequests(){}mostrarErrorCritico(e){}resetMapState(){this.map&&(this.map.setView([this.defaultLatitude,this.defaultLongitude],this.defaultZoom),this.clearLeafletVisuals(),this._viewport.next({x:0,y:0,zoom:this.DEFAULT_ZOOM,width:this._viewport.getValue().width,height:this._viewport.getValue().height}),this.logger.debug("Estado del mapa restablecido"))}clearLeafletVisuals(){}hideErrorNotifications(){}getLastPosition(){return null}getMap(){return this.map}verificarEstadoMapa(){return u(!1)}getViewportChanges$(){return this._viewport.asObservable()}updatePosition(e,t){let r=this._viewport.getValue();this._viewport.next(E(c({},r),{x:e,y:t})),this.logger.debug(`Posici\xF3n del mapa actualizada: x=${e}, y=${t}`)}updateViewportSize(e,t){let r=this._viewport.getValue();this._viewport.next(E(c({},r),{width:e,height:t}))}centerAt(e,t){let r=this._viewport.getValue();this._viewport.next(E(c({},r),{x:e,y:t})),this.logger.debug(`Mapa centrado en: x=${e}, y=${t}`)}centerOnElement(e){if(!e||e.length<2){this.logger.warn("No se puede centrar: posici\xF3n de elemento inv\xE1lida");return}this.centerAt(e[0],e[1])}getCurrentViewport(){return this._viewport.getValue()}static \u0275fac=function(t){return new(t||i)(m($),m(g))};static \u0275prov=h({token:i,factory:i.\u0275fac,providedIn:"root"})};var ue=class i{logger=y(g);mapService=y(k);defaultConfig={enableClustering:!0,clusterDistance:60,enableVirtualization:!0,maxVisibleElements:1e3,enableFPSMonitoring:!0,targetFPS:30,autoOptimize:!0,memoryLimit:500};config;state={fps:0,elementCount:0,visibleElements:0,renderTime:0,memoryUsage:0,isClusteringActive:!1,isVirtualizationActive:!1};configSubject=new l(this.defaultConfig);stateSubject=new l(this.state);isMonitoringSubject=new l(!1);config$=this.configSubject.asObservable();state$=this.stateSubject.asObservable();isMonitoring$=this.isMonitoringSubject.asObservable();frameCount=0;lastFrameTime=0;monitoringStartTime=0;isMonitoring=!1;animationFrameId=null;constructor(){this.config=c({},this.defaultConfig),this.logger.debug("MapPerformanceService inicializado")}initialize(e){this.config=c(c({},this.defaultConfig),e),this.configSubject.next(this.config),this.config.enableFPSMonitoring&&this.startMonitoring(),this.logger.debug("Servicio de rendimiento inicializado",this.config)}updateConfig(e){this.config=c(c({},this.config),e),e.enableClustering!==void 0&&this.toggleClustering(e.enableClustering),e.enableVirtualization!==void 0&&this.toggleVirtualization(e.enableVirtualization),e.enableFPSMonitoring!==void 0&&(e.enableFPSMonitoring?this.startMonitoring():this.stopMonitoring()),this.configSubject.next(this.config),this.logger.debug("Configuraci\xF3n de rendimiento actualizada",e)}startMonitoring(){this.isMonitoring||(this.isMonitoring=!0,this.isMonitoringSubject.next(!0),this.monitoringStartTime=performance.now(),this.frameCount=0,this.lastFrameTime=performance.now(),this.monitorFrames(),this.logger.debug("Monitoreo de rendimiento iniciado"))}stopMonitoring(){this.isMonitoring&&(this.isMonitoring=!1,this.isMonitoringSubject.next(!1),this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.logger.debug("Monitoreo de rendimiento detenido"))}monitorFrames(){let e=()=>{let t=performance.now(),r=t-this.lastFrameTime;if(this.lastFrameTime=t,this.frameCount++,t-this.monitoringStartTime>500){let a=Math.round(this.frameCount*1e3/(t-this.monitoringStartTime));this.updateState({fps:a}),this.frameCount=0,this.monitoringStartTime=t,this.config.autoOptimize&&this.autoOptimize(a)}this.isMonitoring&&(this.animationFrameId=requestAnimationFrame(e))};this.animationFrameId=requestAnimationFrame(e)}autoOptimize(e){let t=this.config.targetFPS;if(e<t*.8){let r={};!this.state.isClusteringActive&&this.state.elementCount>200&&(r.enableClustering=!0),!this.state.isVirtualizationActive&&this.state.elementCount>500&&(r.enableVirtualization=!0,r.maxVisibleElements=Math.min(this.state.elementCount,Math.round(this.state.elementCount*(e/t)))),Object.keys(r).length>0&&(this.updateState({recommendedSettings:r}),this.config.autoOptimize&&(this.updateConfig(r),this.logger.debug("Optimizaciones autom\xE1ticas aplicadas",r)))}}toggleClustering(e){this.state.isClusteringActive=e,this.stateSubject.next(c({},this.state)),this.logger.debug(`Clustering ${e?"activado":"desactivado"}`)}toggleVirtualization(e){this.state.isVirtualizationActive=e,this.stateSubject.next(c({},this.state)),this.logger.debug(`Virtualizaci\xF3n ${e?"activada":"desactivada"}`)}updateState(e){this.state=c(c({},this.state),e),this.stateSubject.next(this.state)}measureExecutionTime(e){let t=performance.now(),r=e(),a=performance.now()-t;return{result:r,time:a}}updateElementCount(e,t){this.updateState({elementCount:e,visibleElements:t})}estimateMemoryUsage(){return X(5e3).pipe(Q(()=>this.isMonitoring),p(()=>{let e=this.state.elementCount*5;return Math.round((e+50)/10)/100}),O(e=>{this.updateState({memoryUsage:e})}))}forceGarbageCollection(){window.gc?(this.logger.debug("Forzando recolecci\xF3n de basura"),window.gc()):this.logger.debug("La recolecci\xF3n de basura manual no est\xE1 disponible en este entorno")}getMetrics(){return this.state$.pipe(p(e=>({fps:e.fps,renderTime:e.renderTime,elementCount:e.elementCount,memoryUsage:e.memoryUsage,elapsed:performance.now()-this.monitoringStartTime})))}getMapStatistics(){return this.state$.pipe(p(e=>{let t="\xD3ptimo";e.fps<30&&e.fps>=20?t="Aceptable":e.fps<20&&e.fps>=10?t="Bajo":e.fps<10&&(t="Cr\xEDtico");let r=e.memoryUsage<1024?`${Math.round(e.memoryUsage)} MB`:`${(e.memoryUsage/1024).toFixed(2)} GB`;return{totalElements:e.elementCount,totalConnections:0,visibleConnections:0,totalAlerts:0,performanceLevel:t,memoryUsageFormatted:r,loadTime:0}}))}clearMemoizationCache(){this.logger.debug("Cach\xE9 de memoizaci\xF3n limpiada")}static \u0275fac=function(t){return new(t||i)};static \u0275prov=h({token:i,factory:i.\u0275fac,providedIn:"root"})};var de=class i{logger=y(g);mapService=y(k);mapStateService=y(re);isInteractionEnabledSubject=new l(!0);isInteractionEnabled$=this.isInteractionEnabledSubject.asObservable();constructor(){this.logger.debug("MapInteractionService inicializado")}disableInteraction(){this.isInteractionEnabledSubject.next(!1),this.logger.debug("Interacciones del mapa deshabilitadas");let e=this.mapService.getMap();e&&(e.dragging.disable(),e.touchZoom.disable(),e.doubleClickZoom.disable(),e.scrollWheelZoom.disable(),e.boxZoom.disable(),e.keyboard.disable())}enableInteraction(){this.isInteractionEnabledSubject.next(!0),this.logger.debug("Interacciones del mapa habilitadas");let e=this.mapService.getMap();e&&(e.dragging.enable(),e.touchZoom.enable(),e.doubleClickZoom.enable(),e.scrollWheelZoom.enable(),e.boxZoom.enable(),e.keyboard.enable())}enablePanning(){this.enableInteraction(),this.mapStateService.setActiveTool("pan"),this.logger.debug("Modo de navegaci\xF3n habilitado");let e=this.mapService.getMap();e&&e.dragging.enable()}enableSelection(){this.enableInteraction(),this.mapStateService.setActiveTool("select"),this.logger.debug("Modo de selecci\xF3n habilitado"),this.mapService.setTool("select")}enableMeasurement(){this.disableInteraction(),this.mapStateService.setActiveTool("measure"),this.logger.debug("Modo de medici\xF3n habilitado"),this.mapService.setTool("measure")}enableConnectionCreation(){this.disableInteraction(),this.mapStateService.setActiveTool("connect"),this.logger.debug("Modo de creaci\xF3n de conexiones habilitado"),this.mapService.setTool("connect")}enableAreaSelection(){this.disableInteraction(),this.mapStateService.setActiveTool("area"),this.logger.debug("Modo de selecci\xF3n por \xE1rea habilitado"),this.mapService.setTool("area")}enableElementEditing(){this.disableInteraction(),this.mapStateService.setActiveTool("edit"),this.logger.debug("Modo de edici\xF3n de elementos habilitado"),this.mapService.setTool("edit")}isToolActive(e){let t="pan";return this.mapStateService.activeTool$.subscribe(r=>t=r).unsubscribe(),t===e}getActiveTool(){return this.mapStateService.activeTool$}selectElement(e){e?e.id?(this.mapStateService.selectElements([e.id],!0),this.logger.debug(`Elemento seleccionado: ${e.id}`)):this.logger.warn("Intento de seleccionar un elemento sin ID",e):(this.mapStateService.setState({selectedElementIds:[]}),this.logger.debug("Elemento deseleccionado"))}selectConnection(e){e?this.logger.debug(`Conexi\xF3n seleccionada: ${e.id||"sin ID"}`):this.logger.debug("Conexi\xF3n deseleccionada")}static \u0275fac=function(t){return new(t||i)};static \u0275prov=h({token:i,factory:i.\u0275fac,providedIn:"root"})};var pe=class i{logger=y(g);mapService=y(k);state={activeTool:"pan",isMeasuring:!1,measurements:[]};activeToolSubject=new l("pan");isMeasuringSubject=new l(!1);measurementsSubject=new l([]);activeMeasurementSubject=new l(void 0);activeTool$=this.activeToolSubject.asObservable();isMeasuring$=this.isMeasuringSubject.asObservable();measurements$=this.measurementsSubject.asObservable();activeMeasurement$=this.activeMeasurementSubject.asObservable();constructor(){this.logger.debug("MapToolsService inicializado")}getActiveTool(){return this.state.activeTool}setActiveTool(e){let t=this.state.activeTool;e!==t&&(this.state.previousTool=t,this.state.activeTool=e,t==="measure"&&this.state.isMeasuring&&this.cancelMeasurement(),this.configureMapForTool(e),this.logger.debug(`Herramienta cambiada: ${t} -> ${e}`),this.activeToolSubject.next(e))}configureMapForTool(e){switch(e){case"pan":this.mapService.disableInteraction(),this.mapService.enablePanning();break;case"select":this.mapService.disableInteraction(),this.mapService.enableSelection();break;case"measure":this.mapService.disableInteraction(),this.mapService.enableMeasurement();break;case"connect":this.mapService.disableInteraction(),this.mapService.enableConnectionCreation();break;case"area":case"polygon":this.mapService.disableInteraction(),this.mapService.enableAreaSelection();break;case"edit":this.mapService.disableInteraction(),this.mapService.enableElementEditing();break;default:this.logger.warn(`Herramienta no reconocida: ${e}`),this.mapService.disableInteraction(),this.mapService.enablePanning()}}restorePreviousTool(){this.state.previousTool?this.setActiveTool(this.state.previousTool):this.setActiveTool("pan")}startMeasurement(){this.state.activeTool!=="measure"&&this.setActiveTool("measure"),this.state.isMeasuring=!0,this.state.activeMeasurement={distance:0,coordinates:[],unit:"m"},this.isMeasuringSubject.next(!0),this.activeMeasurementSubject.next(this.state.activeMeasurement),this.logger.debug("Iniciando medici\xF3n")}updateMeasurement(e,t){!this.state.isMeasuring||!this.state.activeMeasurement||(this.state.activeMeasurement.coordinates.push([t,e]),this.state.activeMeasurement.coordinates.length>1&&(this.state.activeMeasurement.distance=this.calculateTotalDistance(this.state.activeMeasurement.coordinates),this.state.activeMeasurement.distance>1e3&&(this.state.activeMeasurement.unit="km",this.state.activeMeasurement.distance/=1e3)),this.activeMeasurementSubject.next(this.state.activeMeasurement),this.logger.debug(`Medici\xF3n actualizada: ${this.state.activeMeasurement.distance} ${this.state.activeMeasurement.unit}`))}finishMeasurement(){!this.state.isMeasuring||!this.state.activeMeasurement||(this.state.activeMeasurement.coordinates.length>1&&(this.state.measurements.push(c({},this.state.activeMeasurement)),this.measurementsSubject.next([...this.state.measurements]),this.logger.debug(`Medici\xF3n finalizada: ${this.state.activeMeasurement.distance} ${this.state.activeMeasurement.unit}`)),this.state.isMeasuring=!1,this.state.activeMeasurement=void 0,this.isMeasuringSubject.next(!1),this.activeMeasurementSubject.next(void 0))}cancelMeasurement(){this.state.isMeasuring&&(this.state.isMeasuring=!1,this.state.activeMeasurement=void 0,this.isMeasuringSubject.next(!1),this.activeMeasurementSubject.next(void 0),this.logger.debug("Medici\xF3n cancelada"))}clearMeasurements(){this.state.measurements=[],this.measurementsSubject.next([]),this.logger.debug("Mediciones eliminadas")}calculateTotalDistance(e){let t=0;for(let r=1;r<e.length;r++){let[a,o]=e[r-1],[n,s]=e[r];t+=this.calculateDistance(o,a,s,n)}return t}calculateDistance(e,t,r,a){let n=e*Math.PI/180,s=r*Math.PI/180,f=(r-e)*Math.PI/180,M=(a-t)*Math.PI/180,z=Math.sin(f/2)*Math.sin(f/2)+Math.cos(n)*Math.cos(s)*Math.sin(M/2)*Math.sin(M/2);return 6371e3*(2*Math.atan2(Math.sqrt(z),Math.sqrt(1-z)))}static \u0275fac=function(t){return new(t||i)};static \u0275prov=h({token:i,factory:i.\u0275fac,providedIn:"root"})};var V=class i{constructor(e,t,r){this.stateManager=e;this.logger=t;this.networkStateService=r;this.stateManager.layerChanges.pipe(I(this.destroy$)).subscribe(()=>{this.layerChangesSubject.next()}),this.stateManager.activeTool$.pipe(I(this.destroy$)).subscribe(a=>{this.activeToolSubject.next(a)}),this.stateManager.activeLayers.pipe(I(this.destroy$)).subscribe(a=>{this.activeLayersSubject.next(a)}),this.stateManager.isDarkMode.pipe(I(this.destroy$)).subscribe(a=>{this.darkModeSubject.next(a)})}layerChangesSubject=new x;activeToolSubject=new l("pan");activeLayersSubject=new l([]);mapReadySubject=new l(!1);darkModeSubject=new l(!1);destroy$=new x;get layerChanges(){return this.layerChangesSubject.asObservable()}get activeTool$(){return this.activeToolSubject.asObservable()}get activeLayers$(){return this.activeLayersSubject.asObservable()}get mapReady$(){return this.mapReadySubject.asObservable()}get darkMode$(){return this.darkModeSubject.asObservable()}getAllLayers(){try{return this.stateManager.getAllLayers()}catch(e){return this.logger.error("Error al obtener capas en el adaptador",e),[]}}toggleLayerVisibility(e){try{this.stateManager.toggleLayerVisibility(e)}catch(t){this.logger.error(`Error al cambiar visibilidad de capa ${e} en el adaptador`,t)}}setActiveTool(e){try{this.stateManager.setActiveTool(e),this.activeToolSubject.next(e)}catch(t){this.logger.error(`Error al establecer herramienta ${e} en el adaptador`,t)}}setActiveLayers(e){}setDarkMode(e){try{this.stateManager.setDarkMode(e),this.darkModeSubject.next(e)}catch(t){this.logger.error("Error al establecer modo oscuro en el adaptador",t)}}destroy(){this.destroy$.next(),this.destroy$.complete(),this.layerChangesSubject.complete(),this.activeToolSubject.complete(),this.activeLayersSubject.complete(),this.mapReadySubject.complete(),this.darkModeSubject.complete()}static \u0275fac=function(t){return new(t||i)(m(te),m(g),m(ee))};static \u0275prov=h({token:i,factory:i.\u0275fac,providedIn:"root"})};var he=class i{constructor(e,t,r){this.logger=e;this.mapElementManagerAdapter=t;this.mapStateManagerAdapter=r;this.logger.info("StandaloneAdapterService inicializado")}adaptersCache=new Map;featureFlags$=new l({useNewMapImplementation:!0,enableStandaloneMode:!0,useMapContainerInsteadOfNetworkMap:!0});getAdapter(e){if(this.adaptersCache.has(e))return this.adaptersCache.get(e);let t=this.createAdapter(e);return this.adaptersCache.set(e,t),t}createAdapter(e){switch(e){case"MapElementManagerService":return this.mapElementManagerAdapter;case"MapStateManagerService":return this.mapStateManagerAdapter;default:return this.logger.warn(`No se encontr\xF3 adaptador para ${e}, devolviendo proxy gen\xE9rico`),this.createGenericAdapter()}}createGenericAdapter(){return new Proxy({},{get:(e,t)=>{if(typeof t=="string")return(...r)=>(this.logger.debug(`Llamada a m\xE9todo no implementado: ${String(t)}`,r),J)}})}setFeatureFlag(e,t){let r=this.featureFlags$.value;this.featureFlags$.next(E(c({},r),{[e]:t}))}getFeatureFlag(e){return this.featureFlags$.value[e]||!1}get featureFlags(){return this.featureFlags$.asObservable()}getFeatureFlagStream(e){return this.featureFlags.pipe(p(t=>t[e]||!1))}static \u0275fac=function(t){return new(t||i)(m(g),m(ie),m(V))};static \u0275prov=h({token:i,factory:i.\u0275fac,providedIn:"root"})};export{$ as a,ce as b,pe as c,ue as d,he as e,de as f};
