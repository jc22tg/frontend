import{a as f}from"./chunk-QQ6SKILC.js";import{c,f as l,g as o,ja as u,oa as S}from"./chunk-FG6FKNI4.js";import{a as g,b as h}from"./chunk-OXVY4BEJ.js";var V=(()=>{class a{constructor(t){this.logger=t,this.widgetStates=new Map,this.widgetErrors=new l,this.widgetErrors$=this.widgetErrors.asObservable(),this.refreshWidgetsRequest=new l,this.refreshWidgetsRequest$=this.refreshWidgetsRequest.asObservable(),this._allStatesSubject=new o({}),this._isResizing=new o(!1),this.logger.debug("WidgetStateService inicializado")}get allStates$(){return this._allStatesSubject.asObservable()}get isResizing$(){return this._isResizing.asObservable()}getWidgetState(t){return this.widgetStates.has(t)||this.widgetStates.set(t,new o({id:t,isVisible:!0,isCollapsed:!1,lastUpdated:new Date})),this.widgetStates.get(t).asObservable()}getCurrentWidgetState(t){return this.widgetStates.has(t)||this.getWidgetState(t),this.widgetStates.get(t).value}updateWidgetState(t,e){this.widgetStates.has(t)||this.getWidgetState(t);let i=this.widgetStates.get(t).value;this.widgetStates.get(t).next(h(g(g({},i),e),{lastUpdated:new Date}))}setWidgetVisibility(t,e){this.updateWidgetState(t,{isVisible:e})}toggleWidgetCollapse(t){let e=this.getCurrentWidgetState(t);this.updateWidgetState(t,{isCollapsed:!e.isCollapsed})}updateWidgetPosition(t,e){this.updateWidgetState(t,{position:e})}registerWidgetError(t,e){this.updateWidgetState(t,{hasError:!0,errorInfo:{code:e.code,message:e.message,timestamp:new Date}}),this.widgetErrors.next({widgetId:t,code:e.code,message:e.message,details:e.details,timestamp:new Date})}clearWidgetError(t){this.updateWidgetState(t,{hasError:!1,errorInfo:void 0})}refreshAllWidgetsData(t="system"){this.refreshWidgetsRequest.next({source:t})}refreshWidgetsData(t,e="system"){this.refreshWidgetsRequest.next({source:e,targets:t})}getVisibleWidgets(){return new c(t=>{let e=Array.from(this.widgetStates.values()).filter(s=>s.value.isVisible).map(s=>s.value.id);t.next(e);let i=Array.from(this.widgetStates.entries()).map(([s,n])=>n.subscribe(()=>{let d=Array.from(this.widgetStates.values()).filter(r=>r.value.isVisible).map(r=>r.value.id);t.next(d)}));return()=>{i.forEach(s=>s.unsubscribe())}})}resetAllWidgets(){this.widgetStates.forEach((t,e)=>{t.next({id:e,isVisible:!0,isCollapsed:!1,hasError:!1,lastUpdated:new Date})})}updateWidgetZIndex(t,e){this.updateWidgetState(t,{zIndex:e})}recalculateWidgetPositions(){this._isResizing.next(!0);let t=window.innerWidth,e=window.innerHeight,i=0,s=20,n=250,d=150;this.widgetStates.forEach((r,p)=>{let E=r.getValue(),W=Math.floor(i/3),b=i%3,w=s+b*(n+s),m=s+W*(d+s),v=Math.min(w,t-n-s),x=Math.min(m,e-d-s);this.updateWidgetPosition(p,{x:v,y:x}),i++}),this._isResizing.next(!1),this.logger.debug("Widget positions recalculated")}updateCombinedState(){let t={};this.widgetStates.forEach((e,i)=>{t[i]=e.getValue()}),this._allStatesSubject.next(t)}static{this.\u0275fac=function(e){return new(e||a)(S(f))}}static{this.\u0275prov=u({token:a,factory:a.\u0275fac,providedIn:"root"})}}return a})();export{V as a};
