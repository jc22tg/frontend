<div class="element-details-container" *ngIf="element" [@fadeAnimation] role="complementary" aria-label="Detalles del elemento de red" [class.loading]="loading">
  <!-- Cabecera del elemento -->
  <header class="element-header" [ngClass]="getElementTypeClass(element.type)">
    <div class="element-icon-container">
      <mat-icon class="element-type-icon" [matTooltip]="getElementTypeName(element.type)">
        {{ element.type === ElementType.OLT ? 'router' : 
           element.type === ElementType.ONT ? 'devices' :
           element.type === ElementType.ODF ? 'settings_input_component' :
           element.type === ElementType.SPLITTER ? 'call_split' :
           element.type === ElementType.MANGA ? 'device_hub' :
           element.type === ElementType.EDFA ? 'amp_stories' :
           element.type === ElementType.TERMINAL_BOX ? 'inbox' :
           element.type === ElementType.FIBER_THREAD ? 'timeline' : 'device_unknown' }}
      </mat-icon>
      <div class="element-status" 
           [ngClass]="getElementStatusClass(element.status)"
           [matTooltip]="'Estado: ' + (
             element.status === ElementStatus.ACTIVE ? 'Activo' : 
             element.status === ElementStatus.INACTIVE ? 'Inactivo' :
             element.status === ElementStatus.MAINTENANCE ? 'En mantenimiento' :
             element.status === ElementStatus.FAULT ? 'Fallo' : 
             element.status === ElementStatus.PLANNED ? 'Planificado' :
             element.status === ElementStatus.BUILDING ? 'En construcción' :
             element.status === ElementStatus.RESERVED ? 'Reservado' :
             element.status === ElementStatus.DECOMMISSIONED ? 'Fuera de servicio' : 'Desconocido'
           )">
        <mat-icon class="status-icon">{{ getStatusIcon(element.status) }}</mat-icon>
      </div>
    </div>
    <div class="element-title">
      <h2>{{ element.name }}</h2>
      <p class="element-type">{{ getElementTypeName(element.type) }}</p>
    </div>
    <div class="element-actions">
      <button mat-icon-button color="primary" 
              (click)="focusOnMap()" 
              matTooltip="Centrar en mapa" 
              aria-label="Centrar elemento en el mapa">
        <mat-icon>my_location</mat-icon>
      </button>
      <button mat-icon-button color="accent" 
              (click)="onEdit()" 
              matTooltip="Editar elemento" 
              aria-label="Editar elemento">
        <mat-icon>edit</mat-icon>
      </button>
      <button mat-icon-button color="warn" 
              (click)="onDelete()" 
              matTooltip="Eliminar elemento"
              aria-label="Eliminar elemento">
        <mat-icon>delete</mat-icon>
      </button>
    </div>
  </header>

  <div class="details-content" *ngIf="element; else noElement">
    <!-- Información básica del elemento -->
    <section class="element-basic-info">
      <h3 class="section-title">
        <mat-icon>info</mat-icon>
        <span>Información básica</span>
      </h3>

      <div class="property-grid">
        <app-element-detail-row 
          *ngIf="element.id" 
          label="ID" 
          [value]="element.id">
        </app-element-detail-row>
        
        <app-element-detail-row 
          *ngIf="hasProperty('serialNumber')" 
          label="Nº Serie" 
          [value]="getElementProperty('serialNumber')">
        </app-element-detail-row>
        
        <app-element-detail-row 
          *ngIf="hasProperty('model')" 
          label="Modelo" 
          [value]="getElementProperty('model')">
        </app-element-detail-row>
        
        <app-element-detail-row 
          *ngIf="hasProperty('manufacturer')" 
          label="Fabricante" 
          [value]="getElementProperty('manufacturer')">
        </app-element-detail-row>
        
        <app-element-detail-row 
          *ngIf="hasProperty('installDate')" 
          label="Fecha instalación" 
          [value]="formatDate(getElementProperty('installDate'))">
        </app-element-detail-row>
        
        <app-element-detail-row 
          *ngIf="hasProperty('address')" 
          label="Dirección" 
          [value]="getElementProperty('address')">
        </app-element-detail-row>
        
        <app-element-detail-row 
          *ngIf="element.position?.coordinates" 
          label="Coordenadas" 
          [value]="element.position.coordinates[1] + ', ' + element.position.coordinates[0]">
        </app-element-detail-row>
      </div>
    </section>

    <!-- Capacidad y uso -->
    <section class="element-capacity" *ngIf="hasCapacityInfo(element)">
      <h3 class="section-title">
        <mat-icon>speed</mat-icon>
        <span>Capacidad y uso</span>
      </h3>

      <div class="property-grid">
        <app-element-detail-row 
          label="Capacidad total" 
          [value]="getCapacityValue(element)">
        </app-element-detail-row>
        
        <div class="usage-container">
          <div class="usage-label">
            <span>Uso actual</span>
            <span class="usage-value">{{ getUsagePercentage(element) }}%</span>
          </div>
          <div class="usage-bar-container">
            <div class="usage-bar" 
                 [style.width.%]="getUsagePercentage(element)"
                 [ngClass]="{
                    'low': getUsagePercentage(element) < 50,
                    'medium': getUsagePercentage(element) >= 50 && getUsagePercentage(element) < 80,
                    'high': getUsagePercentage(element) >= 80
                 }">
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Propiedades específicas del tipo de elemento -->
    <section class="element-specific-properties" *ngIf="element">
      <h3 class="section-title">
        <mat-icon>settings</mat-icon>
        <span>Propiedades específicas</span>
      </h3>

      <div class="property-grid" [@listAnimation]="getPropertiesCount()">
        <!-- OLT -->
        <ng-container *ngIf="element.type === ElementType.OLT">
          <app-element-detail-row 
            *ngIf="hasProperty('ipAddress')" 
            label="Dirección IP" 
            [value]="getElementProperty('ipAddress')">
          </app-element-detail-row>
          <app-element-detail-row 
            *ngIf="hasProperty('domain')" 
            label="Dominio" 
            [value]="getElementProperty('domain')">
          </app-element-detail-row>
          <app-element-detail-row 
            *ngIf="hasProperty('ponPorts')" 
            label="Puertos PON" 
            [value]="getElementProperty('ponPorts')">
          </app-element-detail-row>
        </ng-container>

        <!-- ONT -->
        <ng-container *ngIf="element.type === ElementType.ONT">
          <app-element-detail-row 
            *ngIf="hasProperty('oltId')" 
            label="OLT asociada" 
            [value]="getElementProperty('oltId')">
          </app-element-detail-row>
          <app-element-detail-row 
            *ngIf="hasProperty('macAddress')" 
            label="Dirección MAC" 
            [value]="getElementProperty('macAddress')">
          </app-element-detail-row>
          <app-element-detail-row 
            *ngIf="hasProperty('signalLevel')" 
            label="Nivel de señal" 
            [value]="(getNumberProperty('signalLevel')?.toFixed(2) || 'N/A') + ' dBm'">
          </app-element-detail-row>
        </ng-container>

        <!-- Splitter -->
        <ng-container *ngIf="element.type === ElementType.SPLITTER">
          <app-element-detail-row 
            *ngIf="hasProperty('ratio')" 
            label="Ratio" 
            [value]="getElementProperty('ratio')">
          </app-element-detail-row>
          <app-element-detail-row 
            *ngIf="hasProperty('level')" 
            label="Nivel" 
            [value]="getElementProperty('level')">
          </app-element-detail-row>
          <app-element-detail-row 
            *ngIf="hasProperty('insertionLoss')" 
            label="Pérdida inserción" 
            [value]="(getNumberProperty('insertionLoss')?.toFixed(2) || 'N/A') + ' dB'">
          </app-element-detail-row>
        </ng-container>

        <!-- EDFA -->
        <ng-container *ngIf="element.type === ElementType.EDFA">
          <app-element-detail-row 
            *ngIf="hasProperty('gainRange')" 
            label="Rango ganancia" 
            [value]="getElementProperty('gainRange')">
          </app-element-detail-row>
          <app-element-detail-row 
            *ngIf="hasProperty('pumpPower')" 
            label="Potencia bomba" 
            [value]="(getNumberProperty('pumpPower')?.toFixed(2) || 'N/A') + ' mW'">
          </app-element-detail-row>
          <app-element-detail-row 
            *ngIf="hasProperty('currentGain')" 
            label="Ganancia actual" 
            [value]="(getNumberProperty('currentGain')?.toFixed(2) || 'N/A') + ' dB'">
          </app-element-detail-row>
        </ng-container>

        <!-- ODF (antes FDP) -->
        <ng-container *ngIf="element.type === ElementType.ODF">
          <app-element-detail-row 
            *ngIf="hasProperty('rackPosition')" 
            label="Posición en rack" 
            [value]="getElementProperty('rackPosition')">
          </app-element-detail-row>
          <app-element-detail-row 
            *ngIf="hasProperty('connectorType')" 
            label="Tipo de conector" 
            [value]="getElementProperty('connectorType')">
          </app-element-detail-row>
        </ng-container>

        <!-- Fibra -->
        <ng-container *ngIf="element.type === ElementType.FIBER_THREAD">
          <app-element-detail-row 
            *ngIf="hasProperty('length')" 
            label="Longitud" 
            [value]="formatValue(getNumberProperty('length'), 'm')">
          </app-element-detail-row>
          <app-element-detail-row 
            *ngIf="hasProperty('attenuation')" 
            label="Atenuación" 
            [value]="formatValue(getNumberProperty('attenuation'), 'dB/km')">
          </app-element-detail-row>
          <app-element-detail-row 
            *ngIf="hasProperty('fiberType')" 
            label="Tipo de fibra" 
            [value]="getElementProperty('fiberType')">
          </app-element-detail-row>
        </ng-container>

        <!-- Generic for other elements -->
        <ng-container *ngIf="![ElementType.OLT, ElementType.ONT, ElementType.SPLITTER, ElementType.EDFA, ElementType.ODF, ElementType.FIBER_THREAD].includes(element.type)">
          <ng-container *ngFor="let property of getGenericProperties(); trackBy: trackByProperty">
          <app-element-detail-row 
              [label]="property[0]" 
              [value]="property[1]">
          </app-element-detail-row>
          </ng-container>
        </ng-container>
      </div>
    </section>

    <!-- Datos de monitoreo -->
    <section class="element-monitoring" *ngIf="element">
      <h3 class="section-title">
        <mat-icon>insights</mat-icon>
        <span>Datos de monitoreo</span>
        <div class="monitoring-timestamp" *ngIf="monitoringData?.timestamp">
          {{ monitoringData?.timestamp | date:'dd/MM/yyyy HH:mm:ss' }}
        </div>
      </h3>

      <div class="loading-container" *ngIf="loading">
        <mat-spinner [diameter]="36" color="accent"></mat-spinner>
        <span>Cargando datos de monitoreo...</span>
      </div>

      <div class="error-container" *ngIf="error && !loading">
        <mat-icon class="error-icon">error</mat-icon>
        <span>{{ error }}</span>
        <button mat-stroked-button color="primary" (click)="loadMonitoringData(element)">
          <mat-icon>refresh</mat-icon>
          Reintentar
        </button>
      </div>

      <div class="property-grid monitoring-grid" *ngIf="monitoringData && !loading && !error" [@listAnimation]="(getMonitoringMetrics().length)">
        <app-element-detail-row 
          *ngFor="let metric of getMonitoringMetrics(); trackBy: trackByProperty"
          [label]="metric[0] | titlecase" 
          [value]="metric[1].value" 
          [suffix]="metric[1].unit"
          [valueClass]="
            metric[0].includes('signal') || metric[0].includes('power') ? 
              (+metric[1].value < -25 ? 'low-value' : 
               +metric[1].value < -15 ? 'medium-value' : 'good-value') : ''
          ">
        </app-element-detail-row>
      </div>

      <div class="no-monitoring-data" *ngIf="!monitoringData && !loading && !error">
        <mat-icon>info</mat-icon>
        <span>No hay datos de monitoreo disponibles</span>
      </div>
    </section>

    <!-- Conexiones -->
    <section class="element-connections" *ngIf="hasConnections()">
      <h3 class="section-title">
        <mat-icon>device_hub</mat-icon>
        <span>Conexiones ({{ getConnectionsCount() }})</span>
      </h3>

      <div class="connections-list" [@listAnimation]="getConnectionsCount()">
        <div class="connection-item" 
             *ngFor="let connection of element.connections; trackBy: trackByConnection"
             (click)="onConnectionClick(connection)"
             matRipple>
          <mat-icon class="connection-icon">link</mat-icon>
          <div class="connection-details">
            <span class="connection-name">{{ connection.name || 'Conexión ' + connection.id }}</span>
            <span class="connection-type" *ngIf="connection.type">{{ connection.type }}</span>
          </div>
          <mat-icon class="navigate-icon">navigate_next</mat-icon>
        </div>
      </div>
    </section>
  </div>

  <ng-template #noElement>
    <div class="no-element-message" role="alert">
      <mat-icon>info</mat-icon>
      <p>Selecciona un elemento en el mapa para ver sus detalles</p>
    </div>
  </ng-template>

  <div class="details-footer" *ngIf="error">
    <div class="error-message" role="alert">
      <mat-icon color="warn">error</mat-icon>
      <span>{{ error }}</span>
    </div>
  </div>

  <div class="loading-overlay" *ngIf="loading" role="progressbar">
    <mat-spinner diameter="32"></mat-spinner>
  </div>
</div>

<!-- Estado de sin selección -->
<div class="no-selection" *ngIf="!element" [@scaleAnimation]>
  <mat-icon class="no-selection-icon">select_all</mat-icon>
  <h3>Ningún elemento seleccionado</h3>
  <p>Seleccione un elemento en el mapa para ver sus detalles</p>
</div> 